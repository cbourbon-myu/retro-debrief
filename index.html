<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Backstage Debrief â€” RÃ©trospective Sprint</title>
  <link rel="icon" type="image/png" href= "assets/favicon.png?v=2"/>
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet"/>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.9/babel.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'DM Sans', sans-serif; background: #F8EBDB; }
    input:focus { outline: none; }
    button { font-family: inherit; }
    @media print { .no-print { display: none !important; } body { background: #fff; } }
    .vote-icon { transition: transform 0.3s ease, filter 0.3s ease !important; }
    .vote-icon:hover { transform: scale(1.3) rotate(-8deg) !important; filter: drop-shadow(0 2px 8px rgba(249,115,22,0.5)) !important; }
    @media (max-width: 768px) { .hide-mobile { display: none !important; } }
    @media (min-width: 769px) { .hide-desktop { display: none !important; } }
  </style>
</head>
<body>
  <div id="root"></div>

  <!-- ============================================================ -->
  <!-- FIREBASE CONFIG                                              -->
  <!-- ============================================================ -->
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyBPH2KoTL5kYXT5c7obYidciDuElmr2C7Y",
      authDomain: "backstage-debrief.firebaseapp.com",
      databaseURL: "https://backstage-debrief-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "backstage-debrief",
      storageBucket: "backstage-debrief.firebasestorage.app",
      messagingSenderId: "313402258283",
      appId: "1:313402258283:web:5f6ce5828effa0a519d22e"
    };
    let db = null;
    let auth = null;
    try { firebase.initializeApp(firebaseConfig); db = firebase.database(); auth = firebase.auth(); }
    catch(e) { console.warn("Firebase init error:", e); }

    // Registre global des templates (rempli par les fichiers templates/*.js)
    window.RETRO_TEMPLATES = window.RETRO_TEMPLATES || {};

    // Charge les templates custom depuis Firebase au dÃ©marrage
    if (db) {
      db.ref("customTemplates").on("value", (snap) => {
        const customs = snap.val();
        if (customs) {
          Object.entries(customs).forEach(([id, tpl]) => {
            window.RETRO_TEMPLATES[id] = { ...tpl, _custom: true };
          });
        }
        // Nettoyage : retirer les custom supprimÃ©s
        Object.keys(window.RETRO_TEMPLATES).forEach(id => {
          if (window.RETRO_TEMPLATES[id]._custom && (!customs || !customs[id])) {
            delete window.RETRO_TEMPLATES[id];
          }
        });
        // Dispatch event pour que React re-render
        window.dispatchEvent(new Event("templates-updated"));
      });
    }
  </script>

  <!-- ============================================================ -->
  <!-- TEMPLATES (ajoute/retire des lignes ici pour gÃ©rer les thÃ¨mes) -->
  <!-- ============================================================ -->
  <script src="templates/backstage.js"></script>
  <script src="templates/starwars.js"></script>
  <script src="templates/gaming.js"></script>
  <script src="templates/retro80.js"></script>
  <script src="templates/kohlanta.js"></script>

  <!-- ============================================================ -->
  <!-- APPLICATION PRINCIPALE                                       -->
  <!-- ============================================================ -->
  <script type="text/babel">
    const { useState, useRef, useEffect, useCallback, useMemo } = React;

    // --- RÃ©cupÃ¨re la liste des templates chargÃ©s ---
    function getTemplates() { return window.RETRO_TEMPLATES || {}; }
    function getTemplateList() { return Object.values(getTemplates()); }
    function getTemplate(id) { return getTemplates()[id] || getTemplateList()[0] || null; }

    // --- Hook pour forcer un re-render quand les templates custom changent ---
    function useTemplateRefresh() {
      const [, setTick] = useState(0);
      useEffect(() => {
        const handler = () => setTick(t => t + 1);
        window.addEventListener("templates-updated", handler);
        return () => window.removeEventListener("templates-updated", handler);
      }, []);
    }

    // --- RESPONSIVE HOOK ---
    function useResponsive() {
      const [width, setWidth] = useState(window.innerWidth);
      useEffect(() => {
        const handle = () => setWidth(window.innerWidth);
        window.addEventListener("resize", handle);
        return () => window.removeEventListener("resize", handle);
      }, []);
      return { isMobile: width <= 768, isTablet: width > 768 && width <= 1024, isDesktop: width > 1024, width };
    }

    // --- AUTH HOOK ---
    function useAuth() {
      const [user, setUser] = useState(null);
      const [loading, setLoading] = useState(true);
      const [error, setError] = useState(null);
      useEffect(() => {
        if (!auth) { setLoading(false); return; }
        return auth.onAuthStateChanged((u) => { setUser(u); setLoading(false); });
      }, []);
      const signIn = async () => {
        setError(null);
        try {
          const provider = new firebase.auth.GoogleAuthProvider();
          provider.setCustomParameters({ hd: "myunisoft.fr" });
          await auth.signInWithPopup(provider);
        } catch (e) { setError(e.message); }
      };
      const signOut = async () => { await auth.signOut(); };
      return { user, loading, error, signIn, signOut };
    }

    // --- FIREBASE DB HOOK ---
    function useFirebase(path, defaultVal, enabled) {
      const [data, setData] = useState(defaultVal);
      const [status, setStatus] = useState("connecting");
      useEffect(() => {
        if (!enabled || !db) { setStatus("offline"); return; }
        const ref = db.ref(path);
        const handler = ref.on("value", (snap) => {
          const val = snap.val();
          setData(val ? Object.values(val) : []);
          setStatus("synced");
        }, (err) => { setStatus("error"); console.error(err); });
        return () => ref.off("value", handler);
      }, [path, enabled]);
      const setItems = useCallback(async (newData) => { if (!db) return; setStatus("saving"); const obj = {}; newData.forEach((item) => { obj[item.id] = item; }); await db.ref(path).set(obj); setStatus("synced"); }, [path]);
      const pushItem = useCallback(async (item) => { if (!db) return; setStatus("saving"); await db.ref(path + "/" + item.id).set(item); setStatus("synced"); }, [path]);
      const removeItem = useCallback(async (id) => { if (!db) return; setStatus("saving"); await db.ref(path + "/" + id).remove(); setStatus("synced"); }, [path]);
      const updateItem = useCallback(async (id, updates) => { if (!db) return; setStatus("saving"); await db.ref(path + "/" + id).update(updates); setStatus("synced"); }, [path]);
      return { data, status, setItems, pushItem, removeItem, updateItem };
    }

    // --- RIDEAU CONCERT ---
    function ConcertCurtain({ visible, catLabel }) {
      if (!visible) return null;
      const folds = Array.from({ length: 8 });
      return (
        <div style={{ position: "fixed", inset: 0, zIndex: 9999, pointerEvents: "none", overflow: "hidden" }}>
          <div style={{ position: "absolute", top: 0, left: 0, width: "50%", height: "100%", animation: "curtainLeft 2.4s cubic-bezier(0.4,0,0.2,1) forwards", display: "flex" }}>
            {folds.map((_, i) => (<div key={i} style={{ flex: 1, height: "100%", background: `linear-gradient(180deg, #6B0000 0%, #CC0000 ${20+i*8}%, #8B0000 ${50+i*4}%, #DC143C 100%)`, boxShadow: i%2===0?"inset -6px 0 12px rgba(0,0,0,0.4)":"inset 6px 0 12px rgba(255,255,255,0.1)", borderRight: "1px solid rgba(0,0,0,0.2)" }} />))}
            <div style={{ position: "absolute", right: -2, top: 0, width: 18, height: "100%", background: "repeating-linear-gradient(180deg, #FFD700 0px, #B8860B 8px, #FFD700 16px)", opacity: 0.9 }} />
          </div>
          <div style={{ position: "absolute", top: 0, right: 0, width: "50%", height: "100%", animation: "curtainRight 2.4s cubic-bezier(0.4,0,0.2,1) forwards", display: "flex", flexDirection: "row-reverse" }}>
            {folds.map((_, i) => (<div key={i} style={{ flex: 1, height: "100%", background: `linear-gradient(180deg, #6B0000 0%, #CC0000 ${20+i*8}%, #8B0000 ${50+i*4}%, #DC143C 100%)`, boxShadow: i%2===0?"inset 6px 0 12px rgba(0,0,0,0.4)":"inset -6px 0 12px rgba(255,255,255,0.1)", borderLeft: "1px solid rgba(0,0,0,0.2)" }} />))}
            <div style={{ position: "absolute", left: -2, top: 0, width: 18, height: "100%", background: "repeating-linear-gradient(180deg, #FFD700 0px, #B8860B 8px, #FFD700 16px)", opacity: 0.9 }} />
          </div>
          <div style={{ position: "absolute", inset: 0, display: "flex", flexDirection: "column", alignItems: "center", justifyContent: "center", gap: 12, animation: "curtainText 2.4s ease forwards" }}>
            <div style={{ fontSize: 64 }}>ğŸ¤”</div>
            <div style={{ fontSize: 22, fontWeight: 800, color: "#FFD700", textShadow: "0 2px 8px rgba(0,0,0,0.6)", textAlign: "center", padding: "0 20px" }}>RÃ©sultats {catLabel}</div>
            <div style={{ fontSize: 14, color: "#FDE047", opacity: 0.8 }}>Tout le monde a votÃ© !</div>
          </div>
        </div>
      );
    }

    // --- ADMINS ---
    const ADMIN_EMAILS = ["c.bourbon@myunisoft.fr", "m.gonzalez@myunisoft.fr"];

    // --- SPRINT DATE + TEMPLATE SELECTION ---
    function SprintDateScreen({ onSave }) {
      const [date, setDate] = React.useState(new Date().toISOString().split("T")[0]);
      const [selectedTemplate, setSelectedTemplate] = React.useState(getTemplateList()[0]?.id || "backstage");
      const { isMobile } = useResponsive();
      useTemplateRefresh();
      const templates = getTemplateList();
      return (
        <div style={{ minHeight: "100vh", background: "#F8EBDB", display: "flex", alignItems: "center", justifyContent: "center", padding: 16 }}>
          <div style={{ background: "#FEF5EC", borderRadius: 24, padding: isMobile ? "28px 16px" : "48px 40px", maxWidth: 600, width: "100%", textAlign: "center", boxShadow: "0 20px 60px rgba(0,0,0,0.1)" }}>
            <img src="assets/backstage/Batterie.png" style={{ width: 100, height: 100, borderRadius: "50%", marginBottom: 12, objectFit: "cover" }} />
            <div style={{ fontSize: 22, fontWeight: 800, color: "#1F2937", marginBottom: 4 }}>Nouveau Sprint !</div>
            <div style={{ fontSize: 13, color: "#6B7280", marginBottom: 20 }}>Configure la session : date et format de rÃ©tro.</div>
            <input type="date" value={date} onChange={e => setDate(e.target.value)} style={{ width: "100%", padding: "12px 14px", borderRadius: 10, border: "1px solid #E8C9A8", fontSize: 15, marginBottom: 20, textAlign: "center" }} />
            <div style={{ fontSize: 13, fontWeight: 700, color: "#1F2937", marginBottom: 12, textAlign: "left" }}>ğŸ­ Choisis le thÃ¨me de la rÃ©tro :</div>
            <div style={{ display: "grid", gridTemplateColumns: isMobile ? "1fr" : "1fr 1fr", gap: 8, marginBottom: 12 }}>
              {templates.map(t => (
                <button key={t.id} onClick={() => setSelectedTemplate(t.id)} style={{
                  padding: "12px 14px", borderRadius: 12, cursor: "pointer",
                  border: selectedTemplate === t.id ? "2.5px solid " + t.accent : "1.5px solid #E8C9A8",
                  background: selectedTemplate === t.id ? (t.dark ? t.cardBg : t.accentLight || "#FFF7ED") : "#FFFAF5",
                  textAlign: "left", transition: "all 0.2s",
                  transform: selectedTemplate === t.id ? "scale(1.02)" : "scale(1)",
                  boxShadow: selectedTemplate === t.id ? "0 4px 16px " + t.accent + "44" : "none",
                }}>
                  <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center" }}>
                    <div style={{ fontSize: 15, fontWeight: 700, color: selectedTemplate === t.id ? (t.dark ? t.accent : t.accentDark) : "#1F2937", marginBottom: 2 }}>{t.name}</div>
                    {t._custom && <span style={{ fontSize: 9, background: "#F59E0B22", color: "#F59E0B", padding: "2px 6px", borderRadius: 4, fontWeight: 700 }}>CUSTOM</span>}
                  </div>
                  <div style={{ fontSize: 11, color: selectedTemplate === t.id ? (t.dark ? t.textSecondary : "#6B7280") : "#9CA3AF" }}>{t.desc}</div>
                  <div style={{ fontSize: 16, marginTop: 4, letterSpacing: 2 }}>{t.preview}</div>
                </button>
              ))}
            </div>
            <button onClick={() => window.open("theme-editor.html", "_blank")} style={{ width: "100%", padding: "10px 0", borderRadius: 10, border: "1.5px dashed #D97706", background: "none", color: "#D97706", fontSize: 13, fontWeight: 600, cursor: "pointer", marginBottom: 24, transition: "all 0.15s" }}
              onMouseEnter={e => { e.currentTarget.style.background = "#FEF3C7"; }}
              onMouseLeave={e => { e.currentTarget.style.background = "none"; }}>
              âœ¨ Personnaliser un thÃ¨me
            </button>
            <button onClick={() => onSave(date, selectedTemplate)} style={{ width: "100%", padding: "14px 0", borderRadius: 12, border: "none", background: "linear-gradient(135deg, #1c0a0a, #3b0f0f)", color: "#F97316", fontSize: 15, fontWeight: 700, cursor: "pointer" }}>ğŸ¤˜ Lancer la rÃ©tro</button>
          </div>
        </div>
      );
    }

    function LoginScreen({ onSignIn, error, loading }) {
      const { isMobile } = useResponsive();
      return (
        <div style={{ minHeight: "100vh", background: "#F8EBDB", display: "flex", alignItems: "center", justifyContent: "center", padding: 16 }}>
          <div style={{ background: "#FEF5EC", borderRadius: 24, padding: isMobile ? "28px 20px 36px" : "36px 56px 56px 56px", maxWidth: 520, width: "100%", textAlign: "center", boxShadow: "0 20px 60px rgba(0,0,0,0.1)" }}>
            <img src="assets/backstage/Batterie.png" style={{ width: isMobile ? 90 : 120, height: isMobile ? 90 : 120, borderRadius: "50%", marginBottom: 12, objectFit: "cover" }} />
            <div style={{ fontSize: isMobile ? 22 : 26, fontWeight: 800, color: "#1F2937", marginBottom: 4 }}>Backstage Debrief</div>
            <div style={{ fontSize: 13, color: "#6B7280", marginBottom: 8 }}>RÃ©tro Sprint â€” MyUnisoft GI</div>
            <button onClick={onSignIn} disabled={loading} style={{ padding: "14px 40px", borderRadius: 12, border: "2px solid #E8C9A8", background: "#FEF5EC", color: "#1F2937", fontSize: 15, fontWeight: 600, cursor: loading ? "wait" : "pointer", display: "flex", alignItems: "center", justifyContent: "center", gap: 10, transition: "all 0.2s", margin: "28px auto 0" }}
              onMouseEnter={e => { if(!loading) e.currentTarget.style.background = "#FCB98B"; }}
              onMouseLeave={e => e.currentTarget.style.background = "#FEF5EC"}>
              <svg width="20" height="20" viewBox="0 0 48 48"><path fill="#EA4335" d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l7.98 6.19C12.43 13.72 17.74 9.5 24 9.5z"/><path fill="#4285F4" d="M46.98 24.55c0-1.57-.15-3.09-.38-4.55H24v9.02h12.94c-.58 2.96-2.26 5.48-4.78 7.18l7.73 6c4.51-4.18 7.09-10.36 7.09-17.65z"/><path fill="#FBBC05" d="M10.53 28.59c-.48-1.45-.76-2.99-.76-4.59s.27-3.14.76-4.59l-7.98-6.19C.92 16.46 0 20.12 0 24c0 3.88.92 7.54 2.56 10.78l7.97-6.19z"/><path fill="#34A853" d="M24 48c6.48 0 11.93-2.13 15.89-5.81l-7.73-6c-2.15 1.45-4.92 2.3-8.16 2.3-6.26 0-11.57-4.22-13.47-9.91l-7.98 6.19C6.51 42.62 14.62 48 24 48z"/></svg>
              {loading ? "Connexionâ€¦" : "Se connecter avec Google"}
            </button>
            <div style={{ fontSize: 11, color: "#9CA3AF", marginTop: 16, fontStyle: "italic" }}>RÃ©servÃ© Ã  l'Ã©quipe MyUnisoft GI</div>
            {error && <div style={{ marginTop: 46, fontSize: 13, color: "#EF4444", background: "#FEF2F2", borderRadius: 8, padding: "8px 8px" }}>{error}</div>}
          </div>
        </div>
      );
    }

    // â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
    // â•‘                    APP PRINCIPALE                    â•‘
    // â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function BackstageDebrief() {
      const { user, loading: authLoading, error: authError, signIn, signOut } = useAuth();
      const { isMobile, isTablet, isDesktop, width } = useResponsive();
      useTemplateRefresh();
      const isAuthed = !!user;
      const userName = user?.displayName?.split(" ")[0] || "Anonyme";
      const isAdmin = ADMIN_EMAILS.includes(user?.email);

      const todayKey = new Date().toISOString().split("T")[0];
      const [sprintDateKey, setSprintDateKey] = useState(null);
      const [templateId, setTemplateId] = useState(getTemplateList()[0]?.id || "backstage");
      const [cfgLoaded, setCfgLoaded] = useState(false);

      useEffect(() => {
        if (!isAuthed || !db) return;
        const dateRef = db.ref("config/sprintDate");
        const tplRef = db.ref("config/templateId");
        dateRef.on("value", (snap) => { setSprintDateKey(snap.val() || null); });
        tplRef.on("value", (snap) => { setTemplateId(snap.val() || getTemplateList()[0]?.id || "backstage"); setCfgLoaded(true); });
        return () => { dateRef.off("value"); tplRef.off("value"); };
      }, [isAuthed]);

      // --- TEMPLATE ACTIF ---
      const T = getTemplate(templateId) || getTemplateList()[0];

      useEffect(() => { if (T) document.body.style.background = T.bodyBg; }, [T?.bodyBg]);

      const sprintDateLabel = sprintDateKey ? new Date(sprintDateKey + "T12:00:00").toLocaleDateString("fr-FR") : "â€”";
      const needsDateSetup = isAdmin && cfgLoaded && sprintDateKey !== todayKey;
      const saveSprintDate = (date, tplId) => { if (db) { db.ref("config/sprintDate").set(date); db.ref("config/templateId").set(tplId || getTemplateList()[0]?.id); } };

      const fb = useFirebase(`retro-${sprintDateKey || todayKey}/feedbacks`, [], isAuthed && cfgLoaded);
      const act = useFirebase(`retro-${sprintDateKey || todayKey}/actions`, [], isAuthed && cfgLoaded);
      const rat = useFirebase(`retro-${sprintDateKey || todayKey}/ratings`, [], isAuthed && cfgLoaded);
      const feedbacks = fb.data; const actions = act.data; const ratingsRaw = rat.data;

      const getRatingsForCategory = (catId) => Array.isArray(ratingsRaw) ? ratingsRaw.filter(r => r.category === catId) : [];
      const getMyRating = (catId) => Array.isArray(ratingsRaw) ? ratingsRaw.find(r => r.category === catId && r.authorUid === user?.uid) : null;

      // --- PRÃ‰SENCE ---
      const [connectedUsers, setConnectedUsers] = useState([]);
      useEffect(() => {
        if (!isAuthed || !db || !sprintDateKey) return;
        const presenceRef = db.ref(`retro-${sprintDateKey}/presence/${user.uid}`);
        const allRef = db.ref(`retro-${sprintDateKey}/presence`);
        const connectedRef = db.ref(".info/connected");
        const registerPresence = () => { presenceRef.set({ name: userName, uid: user.uid, lastSeen: Date.now() }); presenceRef.onDisconnect().remove(); };
        connectedRef.on("value", snap => { if (snap.val() === true) registerPresence(); });
        const heartbeat = setInterval(() => { presenceRef.update({ lastSeen: Date.now() }); }, 30000);
        allRef.on("value", snap => {
          const val = snap.val(); if (!val) { setConnectedUsers([]); return; }
          const now = Date.now(); const active = [];
          Object.entries(val).forEach(([uid, u]) => { if (u.lastSeen && (now - u.lastSeen) < 90000) active.push(u); else db.ref(`retro-${sprintDateKey}/presence/${uid}`).remove(); });
          setConnectedUsers(active);
        });
        const handleUnload = () => presenceRef.remove();
        window.addEventListener("beforeunload", handleUnload);
        return () => { clearInterval(heartbeat); presenceRef.remove(); allRef.off("value"); connectedRef.off("value"); window.removeEventListener("beforeunload", handleUnload); };
      }, [isAuthed, sprintDateKey, user?.uid]);

      const connectedUids = connectedUsers.map(u => u.uid);
      const everyoneVotedFor = (catId) => connectedUids.length > 0 && connectedUids.every(uid => Array.isArray(ratingsRaw) && ratingsRaw.some(r => r.category === catId && r.authorUid === uid));

      const [curtainTriggered, setCurtainTriggered] = useState({});
      const [showResults, setShowResults] = useState({});
      useEffect(() => {
        ["ambiance", "satisfaction", "roti"].forEach(catId => {
          if (everyoneVotedFor(catId) && !curtainTriggered[catId]) { setCurtainTriggered(prev => ({ ...prev, [catId]: true })); setTimeout(() => setShowResults(prev => ({ ...prev, [catId]: true })), 1600); }
        });
      }, [ratingsRaw, connectedUids.length]);

      const activeCurtain = ["ambiance","satisfaction","roti"].find(id => curtainTriggered[id] && !showResults[id]) || null;
      const submitRating = (catId, score) => { const existing = getMyRating(catId); if (existing) rat.updateItem(existing.id, { score }); else rat.pushItem({ id: Date.now(), category: catId, score, author: userName, authorUid: user.uid }); };
      const getAvg = (catId) => { const items = getRatingsForCategory(catId); if (!items.length) return null; return (items.reduce((s, r) => s + r.score, 0) / items.length).toFixed(1); };

      const [selectedCat, setSelectedCat] = useState("rock");
      const [feedbackText, setFeedbackText] = useState("");
      const [actionDesc, setActionDesc] = useState("");
      const [actionResp, setActionResp] = useState("");
      const [editingFeedback, setEditingFeedback] = useState(null);
      const [editingAction, setEditingAction] = useState(null);
      const [showPresence, setShowPresence] = useState(false);
      const [showUserMenu, setShowUserMenu] = useState(false);
      const [showIntegration, setShowIntegration] = useState(false);
      const [zoomedImage, setZoomedImage] = useState(null);
      const [showPitTooltip, setShowPitTooltip] = useState(false);
      const [showThemePicker, setShowThemePicker] = useState(false);
      const [confluenceStatus, setConfluenceStatus] = useState(null);
      const [confluenceUrl, setConfluenceUrl] = useState(null);
      const feedbackInputRef = useRef(null);

      useEffect(() => { const h = (e) => { if (!e.target.closest("[data-dropdown]")) { setShowPresence(false); setShowUserMenu(false); setShowIntegration(false); } }; document.addEventListener("click", h); return () => document.removeEventListener("click", h); }, []);
      useEffect(() => { if (!isAuthed || !db || !sprintDateKey) return; const ref = db.ref(`retro-${sprintDateKey}/confluenceUrl`); ref.on("value", (snap) => { setConfluenceUrl(snap.val() || null); }); return () => ref.off("value"); }, [isAuthed, sprintDateKey]);

      // --- GUARD SCREENS ---
      if (!T) return <div style={{ minHeight: "100vh", background: "#F8EBDB", display: "flex", alignItems: "center", justifyContent: "center" }}><div style={{ fontSize: 18, color: "#EF4444" }}>âš ï¸ Aucun template chargÃ©. VÃ©rifiez les fichiers templates/*.js</div></div>;
      if (authLoading || (isAuthed && !cfgLoaded)) return <div style={{ minHeight: "100vh", background: "#F8EBDB", display: "flex", alignItems: "center", justifyContent: "center" }}><div style={{ fontSize: 48 }}>ğŸ¥</div></div>;
      if (!isAuthed) return <LoginScreen onSignIn={signIn} error={authError} loading={authLoading} />;
      if (needsDateSetup) return <SprintDateScreen onSave={saveSprintDate} />;
      if (!sprintDateKey) return <div style={{ minHeight: "100vh", background: "#F8EBDB", display: "flex", alignItems: "center", justifyContent: "center", padding: 16 }}><div style={{ textAlign: "center", color: "#6B7280", fontSize: 15 }}><div style={{ fontSize: 40, marginBottom: 12 }}>â³</div>En attente de la configuration du sprint par l'animateurâ€¦</div></div>;

      const overallStatus = [fb.status, act.status].includes("error") ? "error" : [fb.status, act.status].includes("saving") ? "saving" : [fb.status, act.status].includes("connecting") ? "connecting" : "synced";
      const addFeedback = () => { if (!feedbackText.trim()) return; fb.pushItem({ id: Date.now(), category: selectedCat, text: feedbackText.trim(), author: userName, authorUid: user.uid }); setFeedbackText(""); feedbackInputRef.current?.focus(); };
      const addAction = () => { if (!actionDesc.trim() || actions.length >= 3) return; act.pushItem({ id: Date.now(), description: actionDesc.trim(), responsable: actionResp.trim(), done: false, authorUid: user.uid }); setActionDesc(""); setActionResp(""); };

      const CONFLUENCE_FUNCTION_URL = "https://clinquant-strudel-f17230.netlify.app/.netlify/functions/export-confluence";

      // --- MARKDOWN EXPORT (dynamique selon template) ---
      const generateMarkdown = () => {
        const dateLabel = sprintDateKey || new Date().toISOString().split("T")[0];
        const catIds = T.categories.map(c => c.id);
        const feedByCat = {}; catIds.forEach(id => { feedByCat[id] = feedbacks.filter(f => f.category === id); });
        const ambianceVotes = Array.isArray(ratingsRaw) ? ratingsRaw.filter(r => r.category === "ambiance") : [];
        const satisfactionVotes = Array.isArray(ratingsRaw) ? ratingsRaw.filter(r => r.category === "satisfaction") : [];
        const rotiVotes = Array.isArray(ratingsRaw) ? ratingsRaw.filter(r => r.category === "roti") : [];
        const avg = (items) => items.length ? (items.reduce((s, r) => s + r.score, 0) / items.length).toFixed(1) : "â€”";
        const LABELS = {}; Object.entries(T.ratingLabels).forEach(([k, v]) => { LABELS[k] = v.emoji + " " + v.label; });
        const allAvgs = [avg(ambianceVotes), avg(satisfactionVotes), avg(rotiVotes)].filter(v => v !== "â€”").map(Number);
        const globalAvg = allAvgs.length ? (allAvgs.reduce((s, v) => s + v, 0) / allAvgs.length).toFixed(1) : "â€”";
        const allAuthors = new Set(); feedbacks.forEach(f => { if (f.author) allAuthors.add(f.author); }); if (Array.isArray(ratingsRaw)) ratingsRaw.forEach(r => { if (r.author) allAuthors.add(r.author); });
        const lines = [];
        lines.push(`# ${T.mdTitle} â€” ${dateLabel}`);
        lines.push(`> ExportÃ© le ${new Date().toLocaleDateString("fr-FR", { day: "2-digit", month: "long", year: "numeric" })}`);
        lines.push("");
        if ([...allAuthors].length) { lines.push(`**ğŸ‘¥ Participants :** ${[...allAuthors].sort().join(", ")}`); lines.push(""); }
        lines.push("---"); lines.push(""); lines.push(`## ${T.mdSummary}`); lines.push(""); lines.push(`### ${T.mdGlobal}`); lines.push("");
        lines.push(`**ğŸ¯ Moyenne globale : ${globalAvg} / 5** ${globalAvg !== "â€”" && Number(globalAvg) > 0 ? (T.ratingLabels[Math.round(Number(globalAvg))]?.emoji || "") : ""}`);
        lines.push(""); lines.push("| ThÃ¨me | Moyenne |"); lines.push("|---|---|");
        lines.push(`| ${T.ratingCatLabels.ambiance} | **${avg(ambianceVotes)} / 5** |`);
        lines.push(`| ${T.ratingCatLabels.satisfaction} | **${avg(satisfactionVotes)} / 5** |`);
        lines.push(`| ${T.ratingCatLabels.roti} | **${avg(rotiVotes)} / 5** |`); lines.push("");
        const pinnedByCat = {}; catIds.forEach(id => { pinnedByCat[id] = (feedByCat[id] || []).filter(f => f.pinned); });
        if (catIds.some(id => pinnedByCat[id].length > 0)) { lines.push(`### ${T.mdPinned}`); lines.push(""); catIds.forEach(id => { if (pinnedByCat[id].length) { lines.push(`**${T.columns[id].title}**`); pinnedByCat[id].forEach(f => lines.push(`- ${f.text}`)); lines.push(""); } }); }
        if (actions.length) { lines.push(`### ${T.mdActions}`); lines.push(""); lines.push("| Action | Responsable | Statut |"); lines.push("|---|---|---|"); actions.forEach(a => lines.push(`| ${a.description} | ${a.responsable || "â€”"} | ${a.done ? "âœ… Fait" : "â³ Ã€ faire"} |`)); lines.push(""); }
        lines.push("---"); lines.push(""); lines.push(`## ${T.mdDetail}`); lines.push("");
        T.vibeChecks.forEach(vc => { const votes = Array.isArray(ratingsRaw) ? ratingsRaw.filter(r => r.category === vc.id) : []; lines.push(`### ${vc.label}`); lines.push(""); lines.push(`**Moyenne : ${avg(votes)} / 5**`); if (votes.length) { lines.push(""); votes.forEach(v => lines.push(`- ${v.author} : ${LABELS[v.score] || v.score}`)); } lines.push(""); });
        catIds.forEach(id => { lines.push(`### ${T.columns[id].title}`); lines.push(""); if (feedByCat[id].length) feedByCat[id].forEach(f => lines.push(`- ${f.text}${f.author ? ` *(${f.author})*` : ""}`)); else lines.push("*Aucun retour*"); lines.push(""); });
        lines.push(`### ${T.ratingCatLabels.roti}`); lines.push(""); lines.push(`**Moyenne : ${avg(rotiVotes)} / 5**`); if (rotiVotes.length) { lines.push(""); rotiVotes.forEach(v => lines.push(`- ${v.author} : ${LABELS[v.score] || v.score}`)); } lines.push("");
        return lines.join("\n");
      };

      const exportMarkdown = () => { const md = generateMarkdown(); const blob = new Blob([md], { type: "text/markdown;charset=utf-8" }); const url = URL.createObjectURL(blob); const a = document.createElement("a"); a.href = url; a.download = `retro-${sprintDateKey}.md`; a.click(); URL.revokeObjectURL(url); };

      const exportToConfluence = async () => {
        if (confluenceStatus === "loading") return; setConfluenceStatus("loading"); setConfluenceUrl(null);
        try {
          const md = generateMarkdown();
          const response = await fetch(CONFLUENCE_FUNCTION_URL, { method: "POST", headers: { "Content-Type": "application/json", "Authorization": "Bearer bkstg-d3br13f-myu-2026-x9k7m2p4" }, body: JSON.stringify({ markdown: md, sprintDate: sprintDateKey, userEmail: user.email }) });
          const result = await response.json(); if (!response.ok) throw new Error(result.error || "Erreur " + response.status);
          setConfluenceStatus("success"); setConfluenceUrl(result.pageUrl); if (db) db.ref(`retro-${sprintDateKey}/confluenceUrl`).set(result.pageUrl); setTimeout(() => setConfluenceStatus(null), 8000);
        } catch (error) { console.error("Confluence export error:", error); setConfluenceStatus("error"); alert(error.message.includes("existe dÃ©jÃ ") ? "Une page existe dÃ©jÃ  pour ce sprint dans confluence !" : "Erreur : " + error.message); setTimeout(() => setConfluenceStatus(null), 4000); }
      };

      const resetAll = async () => {
        if (!confirm("âš ï¸ Remettre Ã  zÃ©ro tous les feedbacks, actions et votes ?")) return;
        await Promise.all(feedbacks.map(item => fb.removeItem(item.id)));
        await Promise.all(actions.map(item => act.removeItem(item.id)));
        await Promise.all((Array.isArray(ratingsRaw) ? ratingsRaw : []).map(item => rat.removeItem(item.id)));
        setCurtainTriggered({}); setShowResults({});
        if (db) db.ref(`retro-${sprintDateKey}/confluenceUrl`).remove(); setConfluenceUrl(null);
      };

      const deleteRetro = async () => {
        if (!confirm("Supprimer TOUTE la rÃ©tro du " + sprintDateLabel + " ? Feedbacks, votes, actions â€” tout sera perdu. Tu reviendras Ã  l'Ã©cran de configuration.")) return;
        const key = sprintDateKey;
        if (!db || !key) return;
        try { await db.ref("retro-" + key).set(null); } catch(e) { console.warn("retro:", e.message); }
        try { await db.ref("config/sprintDate").set(null); } catch(e) { console.warn("sprintDate:", e.message); }
        try { await db.ref("config/templateId").set(null); } catch(e) { console.warn("templateId:", e.message); }
        setCurtainTriggered({}); setShowResults({}); setConfluenceUrl(null);
      };

      const changeTemplate = async (newTplId) => {
        if (db) await db.ref("config/templateId").set(newTplId);
        setShowThemePicker(false);
      };

      const getFeedbacksByCategory = (catId) => feedbacks.filter(f => f.category === catId);
      const syncColors = { synced: "#10B981", saving: "#F59E0B", connecting: "#60A5FA", error: "#EF4444" };
      const voteSize = isMobile ? 42 : 52;
      const voteFontSize = isMobile ? 22 : 26;
      const isDark = T.dark;
      const IMG_LOGO = T.appLogo || "assets/backstage/Batterie.png";
      const IMG_MEETING = T.iconMeeting || "assets/backstage/reu.png";
      const IMG_START = T.iconStart || "assets/backstage/fusee.gif";
      // Helper: garantit le format CSS url("...") pour les backgroundImage
      const bg = s => s && s !== "none" ? (s.startsWith("url(") || s.startsWith("data:") ? (s.startsWith("data:") ? `url("${s}")` : s) : `url("${s}")`) : null;

      // â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
      // â•‘                      RENDER                          â•‘
      // â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      return (
        <div style={{ minHeight: "100vh", zoom: isMobile ? 1 : 1.15 }}>

          {/* ==================== HEADER ==================== */}
          <div style={{ position: "relative", zIndex: 10, padding: isMobile ? "16px 12px" : "32px 32px", display: "flex", alignItems: "center", justifyContent: "space-between", flexWrap: "wrap", gap: isMobile ? 8 : 12, minHeight: isMobile ? 80 : 110 }}>
            {bg(T.headerImage) && <div style={{ position: "absolute", inset: 0, overflow: "hidden", backgroundImage: bg(T.headerImage), backgroundSize: "cover", backgroundPosition: "85% 85%", opacity: 0.45 }} />}
            <div style={{ position: "absolute", inset: 0, overflow: "hidden", background: T.headerGradient }} />
            <div style={{ position: "relative", zIndex: 1 }}>
              <div style={{ fontSize: isMobile ? 17 : 34, fontWeight: 800, color: T.accent, letterSpacing: isMobile ? 1 : 2.5, display: "flex", alignItems: "center" }}>
                <img src={IMG_LOGO} onClick={() => setZoomedImage(IMG_LOGO)} style={{ width: isMobile ? 44 : 72, height: isMobile ? 44 : 72, borderRadius: "50%", objectFit: "cover", marginRight: isMobile ? 8 : 12, cursor: "pointer" }} />
                {T.appTitle}
              </div>
            </div>
            <div style={{ display: "flex", gap: isMobile ? 4 : 8, alignItems: "center", flexWrap: "wrap", position: "relative", zIndex: 1 }}>
              {/* Sync */}
              <div style={{ display: "flex", alignItems: "center", gap: 6, background: "rgba(255,255,255,0.12)", borderRadius: 8, padding: isMobile ? "0 8px" : "0 12px", height: 34 }}>
                <div style={{ width: 10, height: 10, borderRadius: "50%", background: syncColors[overallStatus], flexShrink: 0, animation: overallStatus === "saving" || overallStatus === "connecting" ? "pulse 1s infinite" : "none", boxShadow: "0 0 6px " + syncColors[overallStatus] }} />
                <span style={{ fontSize: 18, lineHeight: 1, display: "flex", alignItems: "center" }}>{overallStatus === "synced" ? "ğŸ¥" : overallStatus === "saving" ? "ğŸ’¾" : overallStatus === "connecting" ? "ğŸ“¡" : "âš ï¸"}</span>
                {!isMobile && <span style={{ fontSize: 12, color: "#fff", opacity: 0.85 }}>{{synced: "En direct", saving: "Enregistrementâ€¦", connecting: "Connexionâ€¦", error: "Erreur"}[overallStatus]}</span>}
              </div>
              {/* PrÃ©sence */}
              <div data-dropdown style={{ position: "relative" }}>
                <button onClick={() => { setShowPresence(!showPresence); setShowUserMenu(false); setShowIntegration(false); }} style={{ display: "flex", alignItems: "center", gap: 6, background: "rgba(255,255,255,0.15)", border: "1.2px solid rgba(255,255,255,0.4)", borderRadius: 8, padding: "0 12px", cursor: "pointer", color: "#fff", fontFamily: "inherit", height: 34 }}>
                  <img src={IMG_MEETING} style={{ width: 32, height: 32, objectFit: "contain" }} />
                  <span style={{ fontSize: 12, fontWeight: 600 }}>{connectedUsers.length}</span>
                  <span style={{ fontSize: 9, opacity: 0.7, transition: "transform 0.2s", display: "inline-block", transform: showPresence ? "rotate(180deg)" : "rotate(0)" }}>â–¼</span>
                </button>
                {showPresence && <div style={{ position: "absolute", top: "calc(100% + 6px)", ...(isMobile ? { left: 0 } : { right: 0 }), minWidth: 200, maxWidth: isMobile ? "calc(100vw - 24px)" : "none", background: "rgba(28,10,10,0.95)", border: "1px solid rgba(255,255,255,0.2)", borderRadius: 10, padding: "8px 0", zIndex: 100, backdropFilter: "blur(12px)", boxShadow: "0 8px 24px rgba(0,0,0,0.4)" }}>
                  <div style={{ fontSize: 10, color: "rgba(255,255,255,0.45)", fontWeight: 600, padding: "4px 14px 8px", textTransform: "uppercase", letterSpacing: 0.5 }}>En ligne â€” {connectedUsers.length} participant{connectedUsers.length > 1 ? "s" : ""}</div>
                  {connectedUsers.map(u => (<div key={u.uid} style={{ display: "flex", alignItems: "center", gap: 8, padding: "6px 14px", fontSize: 12.5, color: "#fff" }}><div style={{ width: 7, height: 7, borderRadius: "50%", background: "#10B981", flexShrink: 0, boxShadow: "0 0 6px #10B981" }} /><span style={{ fontWeight: u.uid === user?.uid ? 600 : 400 }}>{u.name}{u.uid === user?.uid ? " (toi)" : ""}</span></div>))}
                  {connectedUsers.length === 0 && <div style={{ padding: "6px 14px", fontSize: 12, color: "rgba(255,255,255,0.4)" }}>Aucun participant</div>}
                </div>}
              </div>
              {/* Partager */}
              <div data-dropdown style={{ position: "relative" }}>
                <button onClick={() => { setShowIntegration(!showIntegration); setShowPresence(false); setShowUserMenu(false); }} className="no-print" style={{ display: "flex", alignItems: "center", gap: 6, background: "rgba(255,255,255,0.15)", border: "1.2px solid rgba(255,255,255,0.55)", borderRadius: 8, padding: "0 12px", cursor: "pointer", color: "#fff", fontFamily: "inherit", height: 34 }}>
                  <img src={IMG_START} style={{ width: 22, height: 22, objectFit: "contain" }} />
                  {!isMobile && <span style={{ fontSize: 12, fontWeight: 500 }}>Partager</span>}
                  <span style={{ fontSize: 9, opacity: 0.7, transition: "transform 0.2s", display: "inline-block", transform: showIntegration ? "rotate(180deg)" : "rotate(0)" }}>â–¼</span>
                </button>
                {showIntegration && <div style={{ position: "absolute", top: "calc(100% + 6px)", right: 0, minWidth: 220, maxWidth: isMobile ? "calc(100vw - 24px)" : "none", background: "rgba(28,10,10,0.95)", border: "1px solid rgba(255,255,255,0.2)", borderRadius: 10, padding: "6px 0", zIndex: 100, backdropFilter: "blur(12px)", boxShadow: "0 8px 24px rgba(0,0,0,0.4)" }}>
                  <div style={{ fontSize: 10, color: "rgba(255,255,255,0.45)", fontWeight: 600, padding: "4px 14px 8px", textTransform: "uppercase", letterSpacing: 0.5 }}>Partager la rÃ©tro</div>
                  <button onClick={() => { exportMarkdown(); setShowIntegration(false); }} style={{ display: "flex", alignItems: "center", gap: 10, width: "100%", padding: "8px 14px", background: "none", border: "none", cursor: "pointer", color: "#fff", fontSize: 12, fontWeight: 500, fontFamily: "inherit", textAlign: "left" }} onMouseEnter={e => e.currentTarget.style.background = "rgba(255,255,255,0.06)"} onMouseLeave={e => e.currentTarget.style.background = "none"}>
                    <img src="assets/markdown.png" style={{ width: 20, height: 20, objectFit: "contain", flexShrink: 0 }} /><div><div>TÃ©lÃ©charger Markdown</div><div style={{ fontSize: 10, color: "rgba(255,255,255,0.4)", marginTop: 1 }}>Fichier .md en local</div></div>
                  </button>
                  {!confluenceUrl && <button onClick={() => exportToConfluence()} disabled={confluenceStatus === "loading" || confluenceStatus === "success"} style={{ display: "flex", alignItems: "center", gap: 10, width: "100%", padding: "8px 14px", background: "none", border: "none", cursor: (confluenceStatus === "loading" || confluenceStatus === "success") ? "default" : "pointer", color: "#fff", fontSize: 12, fontWeight: 500, fontFamily: "inherit", textAlign: "left", opacity: confluenceStatus === "loading" ? 0.5 : 1 }} onMouseEnter={e => e.currentTarget.style.background = "rgba(255,255,255,0.06)"} onMouseLeave={e => e.currentTarget.style.background = "none"}>
                    {confluenceStatus === "loading" ? <span style={{ fontSize: 16 }}>â³</span> : confluenceStatus === "success" ? <span style={{ fontSize: 16 }}>âœ…</span> : <img src="assets/confluence.png" style={{ width: 20, height: 20, objectFit: "contain" }} />}
                    <div><div>{confluenceStatus === "loading" ? "Export en coursâ€¦" : confluenceStatus === "success" ? "Page crÃ©Ã©e !" : "Publier sur Confluence"}</div><div style={{ fontSize: 10, color: "rgba(255,255,255,0.4)", marginTop: 1 }}>{confluenceStatus === "success" ? "GI â€º Sprint Retrospectives" : "CrÃ©er une page dans GI"}</div></div>
                  </button>}
                  {confluenceUrl && <div style={{ display: "flex", alignItems: "center" }}>
                    <a href={confluenceUrl} target="_blank" rel="noopener noreferrer" onClick={e => e.stopPropagation()} style={{ display: "flex", alignItems: "center", gap: 10, flex: 1, padding: "6px 14px", fontSize: 11, color: "#FDE047", fontWeight: 500, background: "none", cursor: "pointer", fontFamily: "inherit", textAlign: "left", textDecoration: "none" }} onMouseEnter={e => e.currentTarget.style.background = "rgba(255,255,255,0.06)"} onMouseLeave={e => e.currentTarget.style.background = "none"}><span style={{ fontSize: 16 }}>ğŸ”—</span> Voir la page Confluence â†’</a>
                    {isAdmin && <button onClick={(e) => { e.stopPropagation(); if (confirm("Supprimer le lien Confluence ?")) { db.ref(`retro-${sprintDateKey}/confluenceUrl`).remove(); setConfluenceUrl(null); }}} style={{ background: "none", border: "none", cursor: "pointer", padding: "6px 10px" }} onMouseEnter={e => e.currentTarget.querySelector("img").style.opacity = "1"} onMouseLeave={e => e.currentTarget.querySelector("img").style.opacity = "0.35"}><img src="assets/trash.svg" style={{ width: 13, height: 13, objectFit: "contain", opacity: 0.35, transition: "opacity 0.2s" }} /></button>}
                  </div>}
                </div>}
              </div>
              {/* Reset */}
              {isAdmin && <button onClick={resetAll} className="no-print" style={{ display: "flex", alignItems: "center", gap: 4, background: "rgba(255,255,255,0.08)", border: "1.2px solid rgba(255,255,255,0.3)", borderRadius: 8, padding: "0 12px", height: 34, color: "#fff", fontSize: 12, fontWeight: 500, cursor: "pointer", fontFamily: "inherit" }} onMouseEnter={e => e.currentTarget.querySelector("img").style.opacity = "1"} onMouseLeave={e => e.currentTarget.querySelector("img").style.opacity = "0.7"}><img src="assets/trash.svg" style={{ width: 16, height: 16, objectFit: "contain", opacity: 0.7, transition: "opacity 0.2s" }} />{!isMobile && " Reset"}</button>}
              {/* Profil */}
              <div data-dropdown style={{ position: "relative" }}>
                <button onClick={() => { setShowUserMenu(!showUserMenu); setShowPresence(false); setShowIntegration(false); }} style={{ display: "flex", alignItems: "center", gap: 6, background: "rgba(255,255,255,0.2)", border: "none", borderRadius: 8, padding: "0 12px 0 5px", cursor: "pointer", color: "#fff", fontFamily: "inherit", height: 34 }}>
                  {user.photoURL && <img src={user.photoURL} style={{ width: 24, height: 24, borderRadius: "50%" }} referrerPolicy="no-referrer" />}
                  {!isMobile && <span style={{ fontSize: 12, fontWeight: 500 }}>{userName}</span>}
                  <span style={{ fontSize: 9, opacity: 0.7, transition: "transform 0.2s", display: "inline-block", transform: showUserMenu ? "rotate(180deg)" : "rotate(0)" }}>â–¼</span>
                </button>
                {showUserMenu && <div style={{ position: "absolute", top: "calc(100% + 6px)", right: 0, minWidth: 220, maxWidth: isMobile ? "calc(100vw - 24px)" : "none", background: "rgba(28,10,10,0.95)", border: "1px solid rgba(255,255,255,0.2)", borderRadius: 10, padding: "6px 0", zIndex: 100, backdropFilter: "blur(12px)", boxShadow: "0 8px 24px rgba(0,0,0,0.4)" }}>
                  <div style={{ padding: "6px 14px 8px", borderBottom: "1px solid rgba(255,255,255,0.1)" }}><div style={{ fontSize: 12, color: "#fff", fontWeight: 600 }}>{user.displayName}</div><div style={{ fontSize: 10.5, color: "rgba(255,255,255,0.45)", marginTop: 2, wordBreak: "break-all" }}>{user.email}</div></div>
                  {isAdmin && <>
                    <div style={{ fontSize: 9, color: "rgba(255,255,255,0.3)", fontWeight: 700, padding: "8px 14px 4px", textTransform: "uppercase", letterSpacing: 1 }}>Admin</div>
                    <button onClick={() => { setShowThemePicker(true); setShowUserMenu(false); }} style={{ display: "flex", alignItems: "center", gap: 8, width: "100%", padding: "8px 14px", background: "none", border: "none", cursor: "pointer", color: "#fff", fontSize: 12, fontWeight: 500, fontFamily: "inherit", textAlign: "left" }} onMouseEnter={e => e.currentTarget.style.background = "rgba(255,255,255,0.06)"} onMouseLeave={e => e.currentTarget.style.background = "none"}>ğŸ­ Changer le thÃ¨me</button>
                    <button onClick={() => { deleteRetro(); setShowUserMenu(false); }} style={{ display: "flex", alignItems: "center", gap: 8, width: "100%", padding: "8px 14px", background: "none", border: "none", cursor: "pointer", color: "#EF4444", fontSize: 12, fontWeight: 500, fontFamily: "inherit", textAlign: "left" }} onMouseEnter={e => e.currentTarget.style.background = "rgba(255,255,255,0.06)"} onMouseLeave={e => e.currentTarget.style.background = "none"}>ğŸ—‘ï¸ Supprimer la rÃ©tro</button>
                    <div style={{ borderBottom: "1px solid rgba(255,255,255,0.1)", margin: "4px 0" }} />
                  </>}
                  <button onClick={signOut} style={{ display: "flex", alignItems: "center", gap: 8, width: "100%", padding: "8px 14px", background: "none", border: "none", cursor: "pointer", color: "#EF4444", fontSize: 12, fontWeight: 500, fontFamily: "inherit", textAlign: "left" }} onMouseEnter={e => e.currentTarget.style.background = "rgba(255,255,255,0.06)"} onMouseLeave={e => e.currentTarget.style.background = "none"}><img src="assets/logout.png" style={{ width: 16, height: 16, objectFit: "contain" }} /> Se dÃ©connecter</button>
                </div>}
              </div>
            </div>
            {/* Sous-titre */}
            <div style={{ width: "100%", display: "flex", flexDirection: isMobile ? "column" : "row", justifyContent: "space-between", alignItems: isMobile ? "flex-start" : "center", position: "relative", zIndex: 0, marginTop: -4, gap: isMobile ? 2 : 0 }}>
              <div style={{ fontSize: isMobile ? 11 : 13, color: "#fff", opacity: 0.92 }}>{T.subtitle}</div>
              <div style={{ fontSize: isMobile ? 9.5 : 10.5, color: "rgba(255,255,255,0.55)" }}><em>Mode collaboratif temps rÃ©el</em> â€” Sprint du {sprintDateLabel}</div>
            </div>
          </div>

          {/* ==================== MAIN CONTENT ==================== */}
          <div style={{ maxWidth: 1400, margin: "0 auto", padding: isMobile ? "16px 10px 32px" : "24px 20px 40px" }}>
            <ConcertCurtain visible={!!activeCurtain} catLabel={activeCurtain ? T.ratingCatLabels[activeCurtain] : ""} />

            {/* ==================== RÃˆGLES ==================== */}
            <div style={{ borderRadius: 16, padding: 0, marginBottom: 20, position: "relative", zIndex: showPitTooltip ? 20 : "auto", display: "flex", flexDirection: isMobile ? "column" : "row", alignItems: "stretch", minHeight: isMobile ? "auto" : 220 }}>
              {bg(T.rulesImage) && <div style={{ position: "absolute", inset: 0, backgroundImage: bg(T.rulesImage), backgroundSize: "cover", backgroundPosition: "center", opacity: 0.5, borderRadius: 16 }} />}
              <div style={{ position: "absolute", inset: 0, background: isMobile ? T.rulesOverlayMobile : T.rulesOverlayDesktop, borderRadius: 16 }} />
              <div style={{ flex: 1, padding: isMobile ? "16px 16px 20px" : "0px 28px", zIndex: 1, position: "relative", display: "flex", flexDirection: "column", justifyContent: "flex-start" }}>
                <div style={{ fontSize: isMobile ? 20 : 24, fontWeight: 700, color: T.rulesColor, marginBottom: 6, display: "flex", alignItems: "center", gap: 8, position: "relative" }}>
                  <span style={{ fontSize: isMobile ? 28 : 36 }}>{T.rulesTitle}</span>
                  <span onMouseEnter={() => !isMobile && setShowPitTooltip(true)} onMouseLeave={() => setShowPitTooltip(false)} onClick={() => isMobile && setShowPitTooltip(!showPitTooltip)} style={{ cursor: "pointer", position: "relative" }}>
                    {T.rulesName}
                    {showPitTooltip && <div style={{ position: "absolute", bottom: isMobile ? "auto" : "calc(100% + 14px)", top: isMobile ? "calc(100% + 10px)" : "auto", left: isMobile ? "-30px" : "-140px", minWidth: isMobile ? 300 : 480, padding: 0, zIndex: 200, animation: "tooltipFadeIn 0.3s ease", borderRadius: 12, overflow: "hidden", boxShadow: "0 12px 40px rgba(0,0,0,0.6), 0 0 0 1px rgba(255,255,255,0.08)" }}>
                      <div style={{ background: "linear-gradient(135deg, #1a0a0a 0%, #2d1010 40%, #1a0505 100%)", padding: isMobile ? "18px 16px" : "24px 30px 44px 30px", position: "relative", overflow: "hidden" }}>
                        <div style={{ position: "absolute", inset: 0, backgroundImage: bg(T.tooltip?.image) || "url('assets/backstage/GIClub.png')", backgroundSize: "cover", backgroundPosition: "center", opacity: 0.20, filter: "blur(0.5px) grayscale(0.2)" }} />
                        <div style={{ position: "absolute", top: 0, left: 0, right: 0, height: 6, background: "linear-gradient(90deg, transparent, #DC2626, #B91C1C, transparent)" }} />
                        <div style={{ position: "relative", zIndex: 1 }}>
                          <div style={{ fontSize: 10, fontWeight: 800, letterSpacing: 3, textTransform: "uppercase", color: "#DC2626", marginBottom: 20, textAlign: "center" }}>{T.tooltip.title}</div>
                          <div style={{ fontSize: isMobile ? 12 : 15, fontWeight: 700, color: "#FAFAF9", textTransform: "uppercase", lineHeight: 1.4, textAlign: "center", textShadow: "0 2px 8px rgba(220,38,38,0.3)" }}>{T.tooltip.quote}</div>
                          <div style={{ marginTop: 36, fontSize: 9, color: "rgba(255,255,255,0.25)", letterSpacing: 1.5, fontStyle: "italic", textAlign: "right" }}>{T.tooltip.author}</div>
                        </div>
                      </div>
                      <div style={{ position: "absolute", ...(isMobile ? { top: -8, borderLeft: "10px solid transparent", borderRight: "10px solid transparent", borderBottom: "10px solid #1a0a0a" } : { bottom: -8, borderLeft: "10px solid transparent", borderRight: "10px solid transparent", borderTop: "10px solid #1a0a0a" }), left: isMobile ? 60 : 170, width: 0, height: 0 }} />
                    </div>}
                  </span>
                </div>
                <div style={{ display: "flex", flexDirection: "column", gap: isMobile ? 7 : 9, maxWidth: 700, paddingLeft: isMobile ? 10 : 60 }}>
                  {T.rulesItems.map((rule, i) => (<div key={i} style={{ display: "flex", alignItems: "center", gap: 5, fontSize: isMobile ? 12.5 : 14, color: isDark ? T.textSecondary : "#57534E", whiteSpace: isMobile ? "normal" : "nowrap" }}><div style={{ width: 6, height: 6, borderRadius: "50%", background: T.rulesDotColor, flexShrink: 0, marginLeft: isMobile ? 0 : 36 }} />{rule}</div>))}
                </div>
              </div>
            </div>

            {/* ==================== VIBE CHECK ==================== */}
            <div style={{ marginBottom: 24 }}>
              <div style={{ fontSize: isMobile ? 16 : 18, fontWeight: 700, color: T.textPrimary, marginBottom: 14, display: "flex", alignItems: "center", gap: 8 }}>
                <svg width="32" height="32" viewBox="0 0 24 24" fill="none"><defs><linearGradient id="gG" x1="0" y1="0" x2="1" y2="1"><stop offset="0%" stopColor="#FFD700"/><stop offset="50%" stopColor="#FFA500"/><stop offset="100%" stopColor="#B8860B"/></linearGradient></defs><rect x="9" y="2" width="6" height="11" rx="3" fill="url(#gG)" stroke="#B8860B" strokeWidth="0.5"/><path d="M5 11a7 7 0 0 0 14 0" stroke="url(#gG)" strokeWidth="2" strokeLinecap="round" fill="none"/><line x1="12" y1="18" x2="12" y2="21" stroke="url(#gG)" strokeWidth="2" strokeLinecap="round"/><line x1="9" y1="21" x2="15" y2="21" stroke="url(#gG)" strokeWidth="2" strokeLinecap="round"/></svg>
                {T.vibeTitle}
              </div>
              <div style={{ display: "grid", gridTemplateColumns: isMobile ? "1fr" : "1fr 1fr", gap: 14 }}>
                {T.vibeChecks.map(cat => { const myRating = getMyRating(cat.id); const myScore = myRating?.score; const avg = getAvg(cat.id); const voters = getRatingsForCategory(cat.id); return (
                  <div key={cat.id} style={{ background: T.cardBg, borderRadius: 14, border: "2px solid " + cat.border, padding: isMobile ? "14px 10px" : "16px 14px", textAlign: "center" }}>
                    <div style={{ fontSize: isMobile ? 14 : 16, fontWeight: isMobile ? 800 : 700, color: isDark ? cat.border : cat.color, marginBottom: 12, display: "flex", alignItems: "center", justifyContent: "center", gap: 6 }}>{cat.image && <div onClick={() => setZoomedImage(cat.image)} style={{ width: isMobile ? 34 : 30, height: isMobile ? 34 : 30, borderRadius: "50%", overflow: "hidden", flexShrink: 0, cursor: "pointer" }}><img src={cat.image} style={{ width: "110%", height: "110%", objectFit: "cover", marginTop: "-5%", marginLeft: "-5%" }} /></div>}{cat.label}</div>
                    <div style={{ display: "flex", justifyContent: "center", gap: isMobile ? 6 : 10, marginBottom: 12 }}>
                      {[1,2,3,4,5].map(score => (<button key={score} onClick={() => submitRating(cat.id, score)} className="vote-icon" style={{ width: voteSize, height: voteSize, borderRadius: "50%", border: myScore === score ? "2.5px solid " + (isDark ? cat.border : cat.color) : "1.5px solid " + T.inputBorder, background: myScore === score ? cat.bg : T.cardBg, fontSize: voteFontSize, cursor: "pointer", transition: "all 0.2s", transform: myScore === score ? "scale(1.15)" : "scale(1)", boxShadow: myScore === score ? "0 0 12px 4px " + cat.border + "66" : "none", animation: myScore === score ? "voteGlow 2s ease-in-out infinite" : "none" }} title={T.ratingLabels[score].label}>{T.ratingLabels[score].emoji}</button>))}
                    </div>
                    {myScore && <div style={{ fontSize: 11.5, color: isDark ? cat.border : cat.color, fontWeight: 600, marginBottom: 8 }}>Tu as votÃ© : {T.ratingLabels[myScore].emoji} {T.ratingLabels[myScore].label}</div>}
                    {!showResults[cat.id] && <div style={{ fontSize: 11, color: T.textMuted, marginTop: 4, borderTop: "1px solid " + cat.border + "33", paddingTop: 8 }}>{myScore ? (connectedUids.length > 0 ? <>ğŸ”’ {getRatingsForCategory(cat.id).length}/{connectedUids.length} vote{connectedUids.length > 1 ? "s" : ""}</> : null) : <>Choisis ton emoji pour voter ğŸ‘†</>}</div>}
                    {showResults[cat.id] && <div style={{ borderTop: "1px solid " + cat.border + "44", paddingTop: 16, animation: "resultReveal 0.6s ease forwards", marginTop: 6 }}>
                      <div style={{ fontSize: 48, marginBottom: 4 }}>{T.ratingLabels[Math.round(avg)]?.emoji}</div>
                      <div style={{ fontSize: 38, fontWeight: 900, color: isDark ? cat.border : cat.color, lineHeight: 1 }}>{avg}</div>
                      <div style={{ fontSize: 13, color: T.textSecondary, marginBottom: 10 }}>/ 5 â€” {T.ratingLabels[Math.round(avg)]?.label}</div>
                      <div style={{ background: T.progressBg, borderRadius: 99, height: 8, margin: "0 8px 12px", overflow: "hidden" }}><div style={{ height: "100%", borderRadius: 99, background: isDark ? cat.border : cat.color, width: (avg / 5 * 100) + "%", transition: "width 1s ease" }} /></div>
                      <div style={{ fontSize: 10.5, color: T.textMuted, marginBottom: 8 }}>{voters.length} vote{voters.length > 1 ? "s" : ""}</div>
                      <div style={{ display: "flex", justifyContent: "center", gap: 4, flexWrap: "wrap" }}>{voters.map(v => (<span key={v.id} style={{ fontSize: 11, background: cat.bg, color: isDark ? cat.border : cat.color, borderRadius: 8, padding: "3px 8px", fontWeight: 600 }}>{T.ratingLabels[v.score]?.emoji} {v.author}</span>))}</div>
                    </div>}
                  </div>); })}
              </div>
            </div>

            {/* ==================== 3 COLONNES FEEDBACKS ==================== */}
            <div style={{ display: "grid", gridTemplateColumns: isMobile ? "1fr" : isTablet ? "1fr 1fr" : "1fr 1fr 1fr", gap: isMobile ? 12 : 18, marginBottom: 24 }}>
              {T.categories.map(cat => { const col = T.columns[cat.id]; const items = getFeedbacksByCategory(cat.id); return (
                <div key={cat.id} style={{ background: T.cardBg, borderRadius: 16, border: "2px solid " + col.border, minHeight: 130, padding: isMobile ? "14px 12px" : "20px 18px" }}>
                  <div style={{ fontSize: isMobile ? 15 : 17, fontWeight: 700, color: isDark ? col.border : col.color, marginBottom: 12, display: "flex", alignItems: "center", gap: 8 }}>
                    <span style={{ fontSize: isMobile ? 22 : 26 }}>{col.title.split(" ")[0]}</span><span>{col.title.split(" ").slice(1).join(" ")}</span>
                    {items.length > 0 && <span style={{ fontSize: 11, fontWeight: 600, background: col.border + "20", color: isDark ? col.border : col.color, borderRadius: 10, padding: "1px 8px" }}>{items.length}</span>}
                  </div>
                  {items.length === 0 && <div style={{ fontSize: 12.5, color: T.textMuted, fontStyle: "italic", padding: "6px 0" }}>Aucun retour pour le moment</div>}
                  <div style={{ display: "flex", flexDirection: "column", gap: 7 }}>
                    {items.map(fbk => { const isOwner = fbk.authorUid === user?.uid; return (
                      <div key={fbk.id} style={{ background: cat.bg, borderRadius: 10, padding: "9px 11px", fontSize: 13, color: T.textPrimary, border: fbk.pinned ? "2px solid " + col.border : "1px solid " + col.border + "33", animation: "fadeIn 0.3s ease" }}>
                        <div style={{ display: "flex", alignItems: "flex-start", gap: 8 }}>
                          {editingFeedback === fbk.id ? <input autoFocus defaultValue={fbk.text} onBlur={e => { fb.updateItem(fbk.id, { text: e.target.value.trim() || fbk.text }); setEditingFeedback(null); }} onKeyDown={e => e.key === "Enter" && (fb.updateItem(fbk.id, { text: e.target.value.trim() || fbk.text }), setEditingFeedback(null))} style={{ flex: 1, border: "none", background: "transparent", fontSize: 13, fontFamily: "inherit", color: T.textPrimary }} />
                          : <div style={{ flex: 1, cursor: isOwner ? "pointer" : "default" }} onClick={() => isOwner && setEditingFeedback(fbk.id)}>{fbk.text}</div>}
                          {isAdmin && <button onClick={() => fb.updateItem(fbk.id, { pinned: !fbk.pinned })} style={{ background: "none", border: "none", cursor: "pointer", padding: 0, lineHeight: 1, flexShrink: 0, fontSize: 14, opacity: fbk.pinned ? 1 : 0.3, transition: "opacity 0.2s" }} onMouseEnter={e => e.currentTarget.style.opacity = "1"} onMouseLeave={e => e.currentTarget.style.opacity = fbk.pinned ? "1" : "0.3"}>ğŸ“Œ</button>}
                          {isOwner && <button onClick={() => fb.removeItem(fbk.id)} style={{ background: "none", border: "none", cursor: "pointer", padding: 0, lineHeight: 1, flexShrink: 0 }} onMouseEnter={e => e.currentTarget.querySelector("img").style.opacity = "1"} onMouseLeave={e => e.currentTarget.querySelector("img").style.opacity = "0.35"}><img src="assets/trash.svg" style={{ width: 13, height: 13, objectFit: "contain", opacity: 0.35, transition: "opacity 0.2s" }} /></button>}
                        </div>
                        {(fbk.author || fbk.pinned) && <div style={{ display: "flex", alignItems: "center", justifyContent: "space-between", marginTop: 4 }}>{fbk.author ? <div style={{ fontSize: 10.5, color: isDark ? col.border : col.color, opacity: 0.7 }}>â€” {fbk.author}</div> : <div />}{fbk.pinned && <div style={{ fontSize: 7, fontStyle: "italic", fontWeight: 700, color: col.border, letterSpacing: 0.5 }}>Ã‰pinglÃ©</div>}</div>}
                      </div>); })}
                  </div>
                </div>); })}
            </div>

            {/* ==================== FEEDBACK INPUT ==================== */}
            <div className="no-print" style={{ background: T.cardBg, borderRadius: 16, border: "1px solid " + T.cardBorder, padding: isMobile ? "14px 12px" : "20px 24px", marginBottom: 24 }}>
              <div style={{ fontSize: isMobile ? 15 : 17, fontWeight: 700, color: T.textPrimary, marginBottom: 12 }}>{T.feedbackTitle}</div>
              <div style={{ display: "flex", gap: isMobile ? 4 : 8, marginBottom: 12, flexWrap: "wrap" }}>
                {T.categories.map(cat => (<button key={cat.id} onClick={() => setSelectedCat(cat.id)} style={{ padding: isMobile ? "5px 10px" : "5px 15px", borderRadius: 16, fontSize: isMobile ? 11 : 12.5, cursor: "pointer", fontWeight: selectedCat === cat.id ? 700 : 500, transition: "all 0.2s", border: selectedCat === cat.id ? "2px solid " + (isDark ? cat.border : cat.color) : "1.5px solid " + cat.border, background: cat.border, color: "#fff", opacity: selectedCat === cat.id ? 1 : 0.55 }}>{cat.label}</button>))}
              </div>
              <div style={{ display: "flex", gap: 8 }}>
                <input ref={feedbackInputRef} type="text" value={feedbackText} onChange={e => setFeedbackText(e.target.value)} onKeyDown={e => e.key === "Enter" && addFeedback()} placeholder="Votre retour..." style={{ flex: 1, padding: "10px 14px", borderRadius: 10, border: "1px solid " + T.inputBorder, fontSize: 13.5, background: T.inputBg, color: T.textPrimary, minWidth: 0 }} onFocus={e => e.target.style.borderColor = T.categories.find(c => c.id === selectedCat).border} onBlur={e => e.target.style.borderColor = T.inputBorder} />
                <button onClick={addFeedback} style={{ width: 42, height: 42, borderRadius: 10, border: "none", background: T.accent, color: isDark ? "#000" : "#fff", fontSize: 22, fontWeight: 700, cursor: "pointer", flexShrink: 0 }}>+</button>
              </div>
            </div>

            {/* ==================== ROTI + ACTIONS ==================== */}
            <div style={{ marginBottom: 24 }}>
              <div style={{ fontSize: isMobile ? 16 : 18, fontWeight: 700, color: T.textPrimary, marginBottom: 14, display: "flex", alignItems: "center", gap: 8 }}>
                <svg width="32" height="32" viewBox="0 0 24 24" fill="none"><defs><linearGradient id="gG2" x1="0" y1="0" x2="1" y2="1"><stop offset="0%" stopColor="#FFD700"/><stop offset="50%" stopColor="#FFA500"/><stop offset="100%" stopColor="#B8860B"/></linearGradient></defs><rect x="9" y="2" width="6" height="11" rx="3" fill="url(#gG2)" stroke="#B8860B" strokeWidth="0.5"/><path d="M5 11a7 7 0 0 0 14 0" stroke="url(#gG2)" strokeWidth="2" strokeLinecap="round" fill="none"/><line x1="12" y1="18" x2="12" y2="21" stroke="url(#gG2)" strokeWidth="2" strokeLinecap="round"/><line x1="9" y1="21" x2="15" y2="21" stroke="url(#gG2)" strokeWidth="2" strokeLinecap="round"/></svg>
                {T.afterTitle}
              </div>
              <div style={{ display: "grid", gridTemplateColumns: isMobile ? "1fr" : "1fr 1fr", gap: 14, alignItems: "stretch" }}>
                {/* ROTI */}
                {(() => { const cat = T.roti; const myRating = getMyRating(cat.id); const myScore = myRating?.score; const avg = getAvg(cat.id); const voters = getRatingsForCategory(cat.id); return (
                  <div style={{ background: T.cardBg, borderRadius: 14, border: "2px solid " + cat.border, padding: isMobile ? "14px 12px" : "20px 20px", textAlign: "center" }}>
                    <div style={{ fontSize: isMobile ? 14 : 16, fontWeight: isMobile ? 800 : 700, color: isDark ? cat.border : cat.color, marginBottom: 12, display: "flex", alignItems: "center", justifyContent: "center", gap: 10 }}>{cat.image && <img src={cat.image} onClick={() => setZoomedImage(cat.image)} style={{ objectFit: "contain", cursor: "pointer", ...(cat.imageStyle || { width: 30, height: 30 }) }} />}<span>{cat.label}</span></div>
                    <div style={{ display: "flex", justifyContent: "center", gap: isMobile ? 6 : 10, marginBottom: 12, marginTop: 12 }}>
                      {[1,2,3,4,5].map(score => (<button key={score} onClick={() => submitRating(cat.id, score)} className="vote-icon" style={{ width: voteSize, height: voteSize, borderRadius: "50%", border: myScore === score ? "2.5px solid " + (isDark ? cat.border : cat.color) : "1.5px solid " + T.inputBorder, background: myScore === score ? cat.bg : T.cardBg, fontSize: voteFontSize, cursor: "pointer", transition: "all 0.2s", transform: myScore === score ? "scale(1.15)" : "scale(1)", boxShadow: myScore === score ? "0 0 12px 4px " + cat.border + "66" : "none", animation: myScore === score ? "voteGlow 2s ease-in-out infinite" : "none" }} title={T.ratingLabels[score].label}>{T.ratingLabels[score].emoji}</button>))}
                    </div>
                    {myScore && <div style={{ fontSize: 11.5, color: isDark ? cat.border : cat.color, fontWeight: 600, marginBottom: 8 }}>Tu as votÃ© : {T.ratingLabels[myScore].emoji} {T.ratingLabels[myScore].label}</div>}
                    {!showResults[cat.id] && <div style={{ fontSize: 11, color: T.textMuted, marginTop: 4, borderTop: "1px solid " + cat.border + "33", paddingTop: 8 }}>{myScore ? (connectedUids.length > 0 ? <>ğŸ”’ {getRatingsForCategory(cat.id).length}/{connectedUids.length} vote{connectedUids.length > 1 ? "s" : ""}</> : null) : <>Choisis ton emoji pour voter ğŸ‘†</>}</div>}
                    {showResults[cat.id] && <div style={{ borderTop: "1px solid " + cat.border + "44", paddingTop: 16, animation: "resultReveal 0.6s ease forwards", marginTop: 6 }}>
                      <div style={{ fontSize: 48, marginBottom: 4 }}>{T.ratingLabels[Math.round(avg)]?.emoji}</div>
                      <div style={{ fontSize: 38, fontWeight: 900, color: isDark ? cat.border : cat.color, lineHeight: 1 }}>{avg}</div>
                      <div style={{ fontSize: 13, color: T.textSecondary, marginBottom: 10 }}>/ 5 â€” {T.ratingLabels[Math.round(avg)]?.label}</div>
                      <div style={{ background: T.progressBg, borderRadius: 99, height: 8, margin: "0 8px 12px", overflow: "hidden" }}><div style={{ height: "100%", borderRadius: 99, background: isDark ? cat.border : cat.color, width: (avg / 5 * 100) + "%", transition: "width 1s ease" }} /></div>
                      <div style={{ fontSize: 10.5, color: T.textMuted, marginBottom: 8 }}>{voters.length} vote{voters.length > 1 ? "s" : ""}</div>
                      <div style={{ display: "flex", justifyContent: "center", gap: 4, flexWrap: "wrap" }}>{voters.map(v => (<span key={v.id} style={{ fontSize: 11, background: cat.bg, color: isDark ? cat.border : cat.color, borderRadius: 8, padding: "3px 8px", fontWeight: 600 }}>{T.ratingLabels[v.score]?.emoji} {v.author}</span>))}</div>
                    </div>}
                  </div>); })()}

                {/* ACTIONS */}
                <div style={{ background: T.cardBg, borderRadius: 14, border: "2px solid " + T.accent, padding: isMobile ? "14px 12px" : "20px 20px", display: "flex", flexDirection: "column" }}>
                  <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", marginBottom: 12 }}>
                    <div style={{ fontSize: isMobile ? 14 : 16, fontWeight: 700, color: isDark ? T.accent : T.accentDark, display: "flex", alignItems: "center", gap: 8 }}>{T.actionTitle}</div>
                    <div style={{ border: "1.5px solid " + T.accent, borderRadius: 13, padding: "2px 12px", fontSize: 11, fontWeight: 600, color: T.accent, flexShrink: 0, marginLeft: 8 }}>{actions.length}/3</div>
                  </div>
                  <div style={{ borderTop: "1px solid " + T.accent + "33", marginBottom: 12 }} />
                  {actions.length === 0 ? <div style={{ textAlign: "center", padding: "12px 0", fontSize: 13, fontWeight: 600, color: T.textMuted }}>Aucune action dÃ©finie</div> : (
                    <div style={{ display: "flex", flexDirection: "column", gap: 8, marginBottom: 10 }}>
                      {actions.map(action => (
                        <div key={action.id} style={{ background: T.accentLight, borderRadius: 10, padding: "9px 11px", display: "flex", alignItems: "center", gap: 9, border: "1px solid " + T.accent + "40", animation: "fadeIn 0.3s ease" }}>
                          <input type="checkbox" checked={action.done || false} onChange={() => act.updateItem(action.id, { done: !action.done })} style={{ width: 16, height: 16, accentColor: T.accent, cursor: "pointer", flexShrink: 0 }} />
                          <div style={{ flex: 1, minWidth: 0 }}>
                            {editingAction === action.id ? <input autoFocus defaultValue={action.description} onBlur={e => { act.updateItem(action.id, { description: e.target.value }); setEditingAction(null); }} onKeyDown={e => e.key === "Enter" && (act.updateItem(action.id, { description: e.target.value }), setEditingAction(null))} style={{ width: "100%", border: "none", background: "transparent", fontSize: 12.5, fontFamily: "inherit", color: T.textPrimary }} />
                            : <div onClick={() => action.authorUid === user?.uid && setEditingAction(action.id)} style={{ fontSize: 12.5, color: T.textPrimary, cursor: action.authorUid === user?.uid ? "pointer" : "default", textDecoration: action.done ? "line-through" : "none", opacity: action.done ? 0.5 : 1 }}>{action.description}</div>}
                            {action.responsable && <div style={{ fontSize: 10.5, color: T.accent, marginTop: 1, fontWeight: 500, display: "flex", alignItems: "center", gap: 4 }}><img src={IMG_MEETING} style={{ width: 13, height: 13, objectFit: "contain" }} /> {action.responsable}</div>}
                          </div>
                          <button onClick={() => act.removeItem(action.id)} style={{ background: "none", border: "none", cursor: "pointer", display: action.authorUid === user?.uid ? "block" : "none", padding: "0 2px" }} onMouseEnter={e => e.currentTarget.querySelector("img").style.opacity = "1"} onMouseLeave={e => e.currentTarget.querySelector("img").style.opacity = "0.35"}><img src="assets/trash.svg" style={{ width: 13, height: 13, objectFit: "contain", opacity: 0.35, transition: "opacity 0.2s" }} /></button>
                        </div>))}
                    </div>)}
                  {actions.length < 3 && <div className="no-print">
                    <div style={{ borderTop: "1px solid " + T.accent + "33", marginBottom: 10, marginTop: 6 }} />
                    <div style={{ display: "flex", gap: 6, marginBottom: 6, flexDirection: "column" }}>
                      <input type="text" value={actionDesc} onChange={e => setActionDesc(e.target.value)} onKeyDown={e => e.key === "Enter" && addAction()} placeholder="Description de l'action..." style={{ width: "100%", padding: "8px 12px", borderRadius: 8, border: "1px solid " + T.inputBorder, fontSize: 12, background: T.inputBg, color: T.textPrimary }} onFocus={e => e.target.style.borderColor = T.accent} onBlur={e => e.target.style.borderColor = T.inputBorder} />
                      <input type="text" value={actionResp} onChange={e => setActionResp(e.target.value)} onKeyDown={e => e.key === "Enter" && addAction()} placeholder="Responsable..." style={{ width: "100%", padding: "8px 12px", borderRadius: 8, border: "1px solid " + T.inputBorder, fontSize: 12, background: T.inputBg, color: T.textPrimary }} onFocus={e => e.target.style.borderColor = T.accent} onBlur={e => e.target.style.borderColor = T.inputBorder} />
                    </div>
                    <button onClick={addAction} style={{ width: "100%", padding: "9px 0", borderRadius: 8, border: "none", background: "linear-gradient(135deg, " + T.accent + ", " + T.accentDark + ")", color: isDark ? "#000" : "#fff", fontSize: 13, fontWeight: 600, cursor: "pointer" }}>+ Ajouter</button>
                  </div>}
                  <div style={{ textAlign: "center", fontSize: isMobile ? 10 : 11.5, color: T.accent, fontStyle: "italic", opacity: 0.65, marginTop: "auto", paddingTop: 10 }}>{T.actionQuote}</div>
                </div>
              </div>
            </div>

            {/* ==================== RÃ‰SUMÃ‰ ==================== */}
            {(() => {
              const pinnedFeedbacks = feedbacks.filter(f => f.pinned); const pinnedByCat = {}; T.categories.forEach(c => { pinnedByCat[c.id] = pinnedFeedbacks.filter(f => f.category === c.id); });
              const avgAmbiance = getAvg("ambiance"); const avgSatisfaction = getAvg("satisfaction"); const avgRoti = getAvg("roti");
              const hasContent = pinnedFeedbacks.length > 0 || actions.length > 0 || avgAmbiance || avgSatisfaction || avgRoti;
              return (
                <div style={{ borderRadius: 16, padding: 0, marginBottom: 24, position: "relative", overflow: "hidden", minHeight: isMobile ? 120 : 180 }}>
                  {bg(T.summaryImage) && <div style={{ position: "absolute", inset: 0, backgroundImage: bg(T.summaryImage), backgroundSize: "cover", backgroundPosition: "center top", opacity: 0.45 }} />}
                  <div style={{ position: "absolute", inset: 0, background: T.summaryOverlay }} />
                  <div style={{ position: "relative", zIndex: 1, padding: isMobile ? "24px 16px" : "32px 28px" }}>
                    <div style={{ fontSize: isMobile ? 18 : 22, fontWeight: 700, color: T.accent, marginBottom: 20, textAlign: "center" }}>{T.summaryTitle}</div>
                    {!hasContent ? <div style={{ fontSize: isMobile ? 12 : 13.5, color: "rgba(255,255,255,0.5)", fontStyle: "italic", textAlign: "center" }}>{T.summaryPinHint}</div> : (
                      <div style={{ display: "flex", flexDirection: "column", gap: 20 }}>
                        {(avgAmbiance || avgSatisfaction || avgRoti) && <div>
                          <div style={{ fontSize: 11, fontWeight: 700, color: "rgba(255,255,255,0.4)", textTransform: "uppercase", letterSpacing: 1, marginBottom: 10 }}>{T.mdGlobal}</div>
                          <div style={{ display: "flex", gap: isMobile ? 10 : 16, flexWrap: "wrap", justifyContent: "center" }}>
                            {[{ label: T.ratingCatLabels.ambiance, avg: avgAmbiance, color: T.vibeChecks[0]?.border }, { label: T.ratingCatLabels.satisfaction, avg: avgSatisfaction, color: T.vibeChecks[1]?.border }, { label: "ROTI", avg: avgRoti, color: T.roti.border }].filter(v => v.avg).map(v => (
                              <div key={v.label} style={{ background: "rgba(255,255,255,0.08)", borderRadius: 12, padding: isMobile ? "10px 14px" : "12px 20px", textAlign: "center", border: "1px solid " + v.color + "44", minWidth: isMobile ? 90 : 110 }}>
                                <div style={{ fontSize: 24, marginBottom: 2 }}>{T.ratingLabels[Math.round(v.avg)]?.emoji}</div>
                                <div style={{ fontSize: 22, fontWeight: 900, color: v.color }}>{v.avg}</div>
                                <div style={{ fontSize: 10, color: "rgba(255,255,255,0.5)", marginTop: 2 }}>{v.label}</div>
                              </div>))}
                          </div>
                        </div>}
                        {pinnedFeedbacks.length > 0 && <div>
                          <div style={{ fontSize: 11, fontWeight: 700, color: "rgba(255,255,255,0.4)", textTransform: "uppercase", letterSpacing: 1, marginBottom: 10 }}>Retours clÃ©s</div>
                          <div style={{ display: "grid", gridTemplateColumns: isMobile ? "1fr" : "1fr 1fr 1fr", gap: 10 }}>
                            {T.categories.map(cat => { const items = pinnedByCat[cat.id] || []; if (!items.length) return null; const col = T.columns[cat.id]; return (
                              <div key={cat.id} style={{ background: cat.bg + (isDark ? "" : "1F"), borderRadius: 10, border: "1px solid " + col.border + "44", padding: "10px 12px" }}>
                                <div style={{ fontSize: 11, fontWeight: 700, color: col.border, marginBottom: 8 }}>{col.title}</div>
                                <div style={{ display: "flex", flexDirection: "column", gap: 5 }}>{items.map(f => (<div key={f.id} style={{ fontSize: 12, color: "rgba(255,255,255,0.85)", lineHeight: 1.4 }}>â€¢ {f.text}</div>))}</div>
                              </div>); })}
                          </div>
                        </div>}
                        {actions.length > 0 && <div>
                          <div style={{ fontSize: 11, fontWeight: 700, color: "rgba(255,255,255,0.4)", textTransform: "uppercase", letterSpacing: 1, marginBottom: 10 }}>{T.actionTitle}</div>
                          <div style={{ display: "flex", flexDirection: "column", gap: 6 }}>
                            {actions.map(a => (<div key={a.id} style={{ display: "flex", alignItems: "center", gap: 8, background: "rgba(255,255,255,0.06)", borderRadius: 8, padding: "8px 12px", border: "1px solid " + T.accent + "33" }}><span style={{ fontSize: 14 }}>{a.done ? "âœ…" : "ğŸ¯"}</span><div style={{ flex: 1, fontSize: 12.5, color: "rgba(255,255,255,0.85)", textDecoration: a.done ? "line-through" : "none", opacity: a.done ? 0.6 : 1 }}>{a.description}</div>{a.responsable && <div style={{ fontSize: 10.5, color: T.accent, fontWeight: 500 }}>{a.responsable}</div>}</div>))}
                          </div>
                        </div>}
                      </div>)}
                  </div>
                </div>); })()}

            {/* ==================== OUTRO ==================== */}
            {(() => {
              const a1 = getAvg("ambiance"), a2 = getAvg("satisfaction"), a3 = getAvg("roti");
              const vals = [a1, a2, a3].filter(v => v !== null).map(Number);
              const globalAvg = vals.length === 3 ? vals.reduce((s, v) => s + v, 0) / vals.length : null;
              const outroKey = globalAvg === null ? "none" : globalAvg > 4 ? "high" : globalAvg >= 3 ? "mid" : "low";
              const msgData = T.outro[outroKey];
              const gifUrl = T.outroGifs ? T.outroGifs[outroKey] : null;
              return (
                <div style={{ borderRadius: 16, position: "relative", overflow: "hidden", marginBottom: 16, minHeight: isMobile ? 140 : 180 }}>
                  {gifUrl && <div style={{ position: "absolute", inset: -4, backgroundImage: `url(${gifUrl})`, backgroundSize: "cover", backgroundPosition: "center", filter: "blur(0.5px)", opacity: 0.75 }} />}
                  <div style={{ position: "absolute", inset: 0, background: T.summaryOverlay }} />
                  <div style={{ position: "relative", zIndex: 1, padding: isMobile ? "20px 16px" : "28px 32px", textAlign: "left" }}>
                    <div style={{ fontSize: isMobile ? 18 : 22, fontWeight: 700, color: T.accent, marginBottom: 8, textAlign: "center" }}>{T.outroTitle}</div>
                    <div style={{ fontSize: isMobile ? 20 : 28, marginBottom: 8 }}>{msgData.emoji}</div>
                    <div style={{ fontSize: isMobile ? 14 : 18, color: "#fff", fontStyle: "italic", lineHeight: 1.6, textShadow: "0 1px 4px rgba(0,0,0,0.5)" }}>"{msgData.text}"</div>
                  </div>
                </div>); })()}
          </div>

          <style>{`
            @keyframes curtainLeft { 0% { transform: translateX(-100%); } 20% { transform: translateX(0%); } 80% { transform: translateX(0%); } 100% { transform: translateX(-100%); } }
            @keyframes curtainRight { 0% { transform: translateX(100%); } 20% { transform: translateX(0%); } 80% { transform: translateX(0%); } 100% { transform: translateX(100%); } }
            @keyframes curtainText { 0% { opacity: 0; transform: scale(0.5); } 25% { opacity: 1; transform: scale(1.1); } 70% { opacity: 1; transform: scale(1); } 100% { opacity: 0; transform: scale(0.8); } }
            @keyframes resultReveal { 0% { opacity: 0; transform: translateY(10px); } 100% { opacity: 1; transform: translateY(0); } }
            @keyframes fadeIn { from { opacity: 0; transform: translateY(-6px); } to { opacity: 1; transform: translateY(0); } }
            @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.4; } }
            @keyframes voteGlow { 0%, 100% { box-shadow: 0 0 12px 4px rgba(249,115,22,0.35), 0 2px 8px rgba(249,115,22,0.5); } 50% { box-shadow: 0 0 18px 6px rgba(249,115,22,0.5), 0 2px 12px rgba(249,115,22,0.65); } }
            @keyframes tooltipFadeIn { 0% { opacity: 0; transform: translateY(6px); } 100% { opacity: 1; transform: translateY(0); } }
          `}</style>
          {showThemePicker && <div onClick={() => setShowThemePicker(false)} style={{ position: "fixed", inset: 0, background: "rgba(0,0,0,0.7)", zIndex: 9998, display: "flex", alignItems: "center", justifyContent: "center", cursor: "pointer", backdropFilter: "blur(6px)", padding: 16 }}>
            <div onClick={e => e.stopPropagation()} style={{ background: "#FEF5EC", borderRadius: 20, padding: isMobile ? "24px 16px" : "32px 28px", maxWidth: 520, width: "100%", cursor: "default", boxShadow: "0 20px 60px rgba(0,0,0,0.3)", maxHeight: "90vh", overflowY: "auto" }}>
              <div style={{ fontSize: 20, fontWeight: 800, color: "#1F2937", marginBottom: 4, textAlign: "center" }}>ğŸ­ Changer le thÃ¨me</div>
              <div style={{ fontSize: 12, color: "#6B7280", marginBottom: 20, textAlign: "center" }}>Les feedbacks, votes et actions sont conservÃ©s.</div>
              <div style={{ display: "grid", gridTemplateColumns: isMobile ? "1fr" : "1fr 1fr", gap: 8, marginBottom: 12 }}>
                {getTemplateList().map(t => (
                  <div key={t.id} style={{ position: "relative" }}>
                    <button onClick={() => changeTemplate(t.id)} style={{
                      width: "100%", padding: "12px 14px", borderRadius: 12, cursor: "pointer",
                      border: templateId === t.id ? "2.5px solid " + t.accent : "1.5px solid #E8C9A8",
                      background: templateId === t.id ? (t.dark ? t.cardBg : t.accentLight || "#FFF7ED") : "#FFFAF5",
                      textAlign: "left", transition: "all 0.2s",
                      transform: templateId === t.id ? "scale(1.02)" : "scale(1)",
                      boxShadow: templateId === t.id ? "0 4px 16px " + t.accent + "44" : "none",
                    }}>
                      <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center" }}>
                        <div style={{ fontSize: 14, fontWeight: 700, color: templateId === t.id ? (t.dark ? t.accent : t.accentDark) : "#1F2937" }}>{t.name}</div>
                        <div style={{ display: "flex", gap: 4, alignItems: "center" }}>
                          {t._custom && <span style={{ fontSize: 9, background: "#F59E0B22", color: "#F59E0B", padding: "2px 6px", borderRadius: 4, fontWeight: 700 }}>CUSTOM</span>}
                          {templateId === t.id && <span style={{ fontSize: 11, color: t.accent, fontWeight: 700 }}>Actif</span>}
                        </div>
                      </div>
                      <div style={{ fontSize: 11, color: templateId === t.id ? (t.dark ? t.textSecondary : "#6B7280") : "#9CA3AF", marginTop: 2 }}>{t.desc}</div>
                      <div style={{ fontSize: 16, marginTop: 4, letterSpacing: 2 }}>{t.preview}</div>
                    </button>
                    {t._custom && isAdmin && <button onClick={(e) => { e.stopPropagation(); if (confirm("Supprimer le thÃ¨me custom \"" + t.name + "\" ?")) { if (db) db.ref("customTemplates/" + t.id).set(null); if (templateId === t.id) changeTemplate(getTemplateList().find(x => !x._custom)?.id || "backstage"); }}} style={{ position: "absolute", top: 6, right: 6, background: "rgba(239,68,68,0.1)", border: "none", borderRadius: 6, width: 22, height: 22, cursor: "pointer", display: "flex", alignItems: "center", justifyContent: "center", fontSize: 11, color: "#EF4444" }}>âœ•</button>}
                  </div>
                ))}
              </div>
              {isAdmin && <button onClick={() => { setShowThemePicker(false); window.open("theme-editor.html", "_blank"); }} style={{ width: "100%", padding: "10px 0", borderRadius: 10, border: "1.5px dashed #D97706", background: "none", color: "#D97706", fontSize: 13, fontWeight: 600, cursor: "pointer", marginBottom: 12, transition: "all 0.15s" }}
                onMouseEnter={e => { e.currentTarget.style.background = "#FEF3C7"; }}
                onMouseLeave={e => { e.currentTarget.style.background = "none"; }}>
                âœ¨ Personnaliser un thÃ¨me
              </button>}
              <button onClick={() => setShowThemePicker(false)} style={{ width: "100%", padding: "12px 0", borderRadius: 10, border: "1.5px solid #E8C9A8", background: "none", color: "#6B7280", fontSize: 13, fontWeight: 600, cursor: "pointer" }}>Fermer</button>
            </div>
          </div>}
          {zoomedImage && <div onClick={() => setZoomedImage(null)} style={{ position: "fixed", inset: 0, background: "rgba(0,0,0,0.7)", zIndex: 9999, display: "flex", alignItems: "center", justifyContent: "center", cursor: "pointer", backdropFilter: "blur(6px)" }}><img src={zoomedImage} style={{ maxWidth: isMobile ? "95vw" : "80vw", maxHeight: "80vh", objectFit: zoomedImage === IMG_LOGO ? "cover" : "contain", borderRadius: zoomedImage === IMG_LOGO ? "50%" : 16, boxShadow: "0 12px 40px rgba(0,0,0,0.5)", ...(zoomedImage === IMG_LOGO ? { width: isMobile ? "70vw" : "60vh", height: isMobile ? "70vw" : "60vh" } : {}) }} /></div>}
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById("root")).render(<BackstageDebrief />);
  </script>
</body>
</html>
