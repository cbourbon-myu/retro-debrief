<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>üé≠ Retro Debrief ‚Äî √âditeur de Th√®me</title>
<link rel="icon" type="image/png" href="assets/favicon.png"/>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.9/babel.min.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet" />
<style>
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
  body { font-family: 'DM Sans', sans-serif; background: #0F0F0F; color: #E5E5E5; min-height: 100vh; }
  .app { display: grid; grid-template-columns: 440px 1fr; height: 100vh; }
  @media (max-width: 900px) { .app { grid-template-columns: 1fr; } .preview-panel { display: none; } }
  .sidebar { background: #161616; border-right: 1px solid #2A2A2A; overflow-y: auto; display: flex; flex-direction: column; }
  .sidebar-header { padding: 20px 18px 12px; border-bottom: 1px solid #2A2A2A; flex-shrink: 0; }
  .sidebar-header h1 { font-size: 18px; font-weight: 800; color: #F97316; letter-spacing: 0.5px; }
  .sidebar-header p { font-size: 11px; color: #666; margin-top: 4px; }
  .tabs { display: flex; flex-wrap: wrap; gap: 2px; padding: 10px 12px; border-bottom: 1px solid #2A2A2A; flex-shrink: 0; }
  .tab { padding: 6px 10px; border-radius: 6px; border: none; background: none; color: #777; font-size: 11px; font-weight: 600; cursor: pointer; font-family: inherit; transition: all 0.15s; white-space: nowrap; }
  .tab:hover { color: #bbb; background: #1E1E1E; }
  .tab.active { color: #F97316; background: #261A0F; }
  .section { padding: 14px 16px; flex: 1; overflow-y: auto; }
  .section-title { font-size: 11px; font-weight: 700; color: #555; text-transform: uppercase; letter-spacing: 1.5px; margin: 16px 0 8px; }
  .section-title:first-child { margin-top: 0; }
  .section-desc { font-size: 10px; color: #999; margin: -4px 0 10px; font-style: italic; }
  .field { margin-bottom: 10px; }
  .field label { display: block; font-size: 11px; font-weight: 600; color: #888; margin-bottom: 4px; }
  .field input[type="text"], .field input[type="url"], .field textarea, .field select { width: 100%; padding: 8px 10px; border-radius: 8px; border: 1px solid #333; background: #1A1A1A; color: #E5E5E5; font-size: 12px; font-family: inherit; outline: none; transition: border-color 0.15s; }
  .field input:focus, .field textarea:focus, .field select:focus { border-color: #F97316; }
  .field textarea { resize: vertical; min-height: 60px; }
  .field-row { display: flex; gap: 8px; align-items: flex-end; }
  .field-row .field { flex: 1; }
  .color-field { display: flex; align-items: center; gap: 8px; }
  .color-field input[type="color"] { width: 32px; height: 32px; border: 2px solid #333; border-radius: 6px; cursor: pointer; background: none; padding: 0; }
  .color-field input[type="color"]::-webkit-color-swatch { border-radius: 4px; border: none; }
  .color-field input[type="color"]::-webkit-color-swatch-wrapper { padding: 2px; }
  .toggle-row { display: flex; align-items: center; justify-content: space-between; padding: 8px 0; }
  .toggle-label { font-size: 12px; font-weight: 600; color: #aaa; }
  .toggle { width: 40px; height: 22px; border-radius: 12px; border: none; cursor: pointer; position: relative; transition: background 0.2s; }
  .toggle.on { background: #F97316; } .toggle.off { background: #333; }
  .toggle::after { content: ''; position: absolute; width: 16px; height: 16px; border-radius: 50%; background: white; top: 3px; transition: left 0.2s; }
  .toggle.on::after { left: 21px; } .toggle.off::after { left: 3px; }
  .emoji-grid { display: grid; grid-template-columns: auto 1fr 1fr; gap: 6px; align-items: center; margin-bottom: 6px; }
  .emoji-grid .num { font-size: 11px; color: #555; font-weight: 700; text-align: center; width: 18px; }
  .array-item { background: #1A1A1A; border: 1px solid #2A2A2A; border-radius: 10px; padding: 10px 12px; margin-bottom: 8px; }
  .array-item-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px; }
  .array-item-title { font-size: 12px; font-weight: 700; color: #ccc; }
  .btn-remove { background: none; border: none; color: #EF4444; cursor: pointer; font-size: 14px; padding: 2px 6px; border-radius: 4px; }
  .btn-remove:hover { background: rgba(239,68,68,0.1); }
  .btn-add { padding: 8px 14px; border-radius: 8px; border: 1px dashed #444; background: none; color: #888; font-size: 12px; cursor: pointer; width: 100%; font-family: inherit; font-weight: 600; transition: all 0.15s; }
  .btn-add:hover { border-color: #F97316; color: #F97316; }
  .outro-block { background: #1A1A1A; border: 1px solid #2A2A2A; border-radius: 10px; padding: 10px 12px; margin-bottom: 8px; }
  .outro-block-title { font-size: 11px; font-weight: 700; color: #F97316; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 1px; }
  .preview-panel { overflow-y: auto; padding: 24px; background: #0F0F0F; }
  .preview-card { border-radius: 16px; overflow: hidden; margin-bottom: 16px; }
  .btn-bar { padding: 12px 16px; border-top: 1px solid #2A2A2A; display: flex; gap: 8px; flex-shrink: 0; }
  .btn-primary { flex: 1; padding: 10px; border-radius: 10px; border: none; background: linear-gradient(135deg, #F97316, #EA580C); color: white; font-size: 13px; font-weight: 700; cursor: pointer; font-family: inherit; transition: transform 0.1s; }
  .btn-primary:hover { transform: scale(1.02); }
  .btn-secondary { padding: 10px; border-radius: 10px; border: 1px solid #444; background: none; color: #aaa; font-size: 13px; font-weight: 600; cursor: pointer; font-family: inherit; }
  .btn-secondary:hover { border-color: #888; color: #ddd; }
  .btn-danger { padding: 10px; border-radius: 10px; border: 1px solid #7F1D1D; background: none; color: #EF4444; font-size: 13px; font-weight: 600; cursor: pointer; font-family: inherit; }
  .btn-danger:hover { background: #7F1D1D22; }
  .status-bar { padding: 8px 16px; border-top: 1px solid #2A2A2A; font-size: 11px; color: #555; display: flex; align-items: center; justify-content: space-between; flex-shrink: 0; }
  .status-dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; margin-right: 6px; }
  .login-screen { min-height: 100vh; background: #0F0F0F; display: flex; align-items: center; justify-content: center; padding: 16px; }
  .login-card { background: #161616; border: 1px solid #2A2A2A; border-radius: 20px; padding: 40px 32px; max-width: 420px; width: 100%; text-align: center; }
  .base-picker { padding: 12px 16px; border-bottom: 1px solid #2A2A2A; flex-shrink: 0; }
  .base-picker select { width: 100%; padding: 8px 10px; border-radius: 8px; border: 1px solid #333; background: #1A1A1A; color: #ccc; font-size: 12px; font-family: inherit; }

  /* Custom themes list */
  .custom-themes { padding: 10px 16px; border-bottom: 1px solid #2A2A2A; flex-shrink: 0; }
  .custom-themes-title { font-size: 10px; font-weight: 700; color: #555; text-transform: uppercase; letter-spacing: 1.5px; margin-bottom: 8px; display: flex; align-items: center; justify-content: space-between; }
  .custom-themes-title span { background: #2A2A2A; color: #888; font-size: 10px; padding: 1px 7px; border-radius: 10px; font-weight: 600; }
  .ct-item { display: flex; align-items: center; gap: 8px; padding: 7px 10px; border-radius: 8px; background: #1A1A1A; border: 1px solid #2A2A2A; margin-bottom: 4px; cursor: pointer; transition: all 0.15s; }
  .ct-item:hover { border-color: #444; background: #1E1E1E; }
  .ct-item.active { border-color: #F97316; background: #261A0F; }
  .ct-emoji { font-size: 14px; flex-shrink: 0; width: 28px; text-align: center; }
  .ct-info { flex: 1; min-width: 0; }
  .ct-name { font-size: 12px; font-weight: 600; color: #ddd; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .ct-id { font-size: 10px; color: #555; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .ct-actions { display: flex; gap: 4px; flex-shrink: 0; }
  .ct-btn { padding: 3px 6px; border-radius: 5px; border: 1px solid transparent; background: none; cursor: pointer; font-size: 12px; transition: all 0.15s; }
  .ct-btn.open:hover { background: #261A0F; border-color: #F97316; }
  .ct-btn.delete:hover { background: #1F0A0A; border-color: #EF4444; }

  /* Color Picker Popup */
  .cpk-overlay { position: fixed; inset: 0; z-index: 9999; display: flex; align-items: center; justify-content: center; background: rgba(0,0,0,0.6); backdrop-filter: blur(4px); }
  .cpk-popup { background: #1A1A1A; border: 1px solid #333; border-radius: 16px; padding: 20px; width: 320px; box-shadow: 0 20px 60px rgba(0,0,0,0.5); }
  .cpk-spectrum { width: 100%; height: 160px; border-radius: 8px; cursor: crosshair; position: relative; margin-bottom: 10px; border: 1px solid #333; }
  .cpk-hue-bar { width: 100%; height: 16px; border-radius: 8px; cursor: pointer; margin-bottom: 10px; border: 1px solid #333; }
  .cpk-alpha-bar { width: 100%; height: 16px; border-radius: 8px; cursor: pointer; margin-bottom: 12px; border: 1px solid #333; background-image: linear-gradient(45deg, #333 25%, transparent 25%), linear-gradient(-45deg, #333 25%, transparent 25%), linear-gradient(45deg, transparent 75%, #333 75%), linear-gradient(-45deg, transparent 75%, #333 75%); background-size: 10px 10px; background-position: 0 0, 0 5px, 5px -5px, -5px 0px; position: relative; overflow: hidden; }
  .cpk-palette { display: grid; grid-template-columns: repeat(10, 1fr); gap: 3px; margin-bottom: 12px; }
  .cpk-palette button { width: 100%; aspect-ratio: 1; border-radius: 4px; border: 1px solid #333; cursor: pointer; transition: transform 0.1s, border-color 0.1s; }
  .cpk-palette button:hover { transform: scale(1.15); border-color: #fff; z-index: 1; }
  .cpk-inputs { display: flex; gap: 6px; align-items: center; margin-bottom: 12px; }
  .cpk-inputs input { padding: 6px 8px; border-radius: 6px; border: 1px solid #333; background: #111; color: #E5E5E5; font-size: 12px; font-family: inherit; outline: none; width: 100%; }
  .cpk-inputs input:focus { border-color: #F97316; }
  .cpk-preview { width: 100%; height: 36px; border-radius: 8px; border: 1px solid #333; margin-bottom: 12px; }
  .cpk-btns { display: flex; gap: 8px; }
  .cpk-btns button { flex: 1; padding: 8px; border-radius: 8px; font-size: 12px; font-weight: 600; cursor: pointer; font-family: inherit; }

  /* Gradient Builder */
  .grad-stop { display: flex; gap: 6px; align-items: center; background: #111; border: 1px solid #2A2A2A; border-radius: 8px; padding: 6px 8px; margin-bottom: 4px; }
  .grad-stop input[type="color"] { width: 28px; height: 28px; border: 1px solid #444; border-radius: 4px; cursor: pointer; background: none; padding: 0; flex-shrink: 0; }
  .grad-stop input[type="color"]::-webkit-color-swatch { border-radius: 3px; border: none; }
  .grad-stop input[type="color"]::-webkit-color-swatch-wrapper { padding: 1px; }
  .grad-stop input[type="text"], .grad-stop input[type="number"] { padding: 5px 6px; border-radius: 4px; border: 1px solid #333; background: #1A1A1A; color: #ccc; font-size: 11px; font-family: inherit; outline: none; }
  .grad-preview { height: 32px; border-radius: 8px; border: 1px solid #333; margin: 8px 0; }

  /* Section Reorder (drag and drop) */
  .reorder-item { display: flex; align-items: center; gap: 10px; background: #1A1A1A; border: 1px solid #2A2A2A; border-radius: 10px; padding: 10px 14px; margin-bottom: 6px; cursor: grab; transition: all 0.15s; user-select: none; }
  .reorder-item:active { cursor: grabbing; }
  .reorder-item.dragging { opacity: 0.4; border-color: #F97316; }
  .reorder-item.drag-over { border-color: #F97316; background: #261A0F; transform: scale(1.02); }
  .reorder-item.locked { opacity: 0.5; cursor: not-allowed; background: #111; }
  .reorder-handle { font-size: 16px; color: #555; flex-shrink: 0; }
  .reorder-label { flex: 1; font-size: 13px; font-weight: 600; color: #ccc; }
  .reorder-lock { font-size: 11px; color: #555; }

  /* Image upload field */
  .uf-wrap { display: flex; flex-direction: column; gap: 6px; }
  .uf-row { display: flex; gap: 6px; align-items: center; }
  .uf-row input[type="text"] { flex: 1; }
  .uf-preview { width: 40px; height: 40px; border-radius: 6px; border: 1px solid #333; object-fit: cover; flex-shrink: 0; cursor: pointer; background: #111; }
  .uf-btn { padding: 4px 8px; border-radius: 6px; border: 1px solid #333; background: #1A1A1A; color: #ccc; cursor: pointer; font-size: 11px; font-family: inherit; white-space: nowrap; transition: border-color 0.2s, background 0.2s; }
  .uf-btn:hover { border-color: #F97316; background: #261A0F; color: #F97316; }
  .uf-btn.danger:hover { border-color: #EF4444; background: #1F0A0A; color: #EF4444; }

  /* Collapsible sections */
  .collapse-header { display: flex; align-items: center; justify-content: space-between; cursor: pointer; padding: 4px 0; margin: 16px 0 0; user-select: none; transition: opacity 0.15s; }
  .collapse-header:first-child { margin-top: 0; }
  .collapse-header:hover { opacity: 0.8; }
  .collapse-header .section-title { margin: 0; pointer-events: none; flex: 1; }
  .collapse-chevron { font-size: 12px; color: #555; transition: transform 0.2s; padding: 2px 4px; }
  .collapse-chevron.open { transform: rotate(90deg); }
  .collapse-body { transition: max-height 0.3s ease, opacity 0.2s ease; }
  .collapse-body.closed { max-height: 0; opacity: 0; padding: 0; overflow: hidden; }
  .collapse-body.open { max-height: 3000px; opacity: 1; padding-top: 8px; overflow: visible; }
</style>
</head>
<body>
<div id="root"></div>
<script>
  var ADMIN_EMAILS = ["c.bourbon@myunisoft.fr", "m.gonzalez@myunisoft.fr"];
  var firebaseConfig = { apiKey: "AIzaSyBPH2KoTL5kYXT5c7obYidciDuElmr2C7Y", authDomain: "backstage-debrief.firebaseapp.com", databaseURL: "https://backstage-debrief-default-rtdb.europe-west1.firebasedatabase.app", projectId: "backstage-debrief", storageBucket: "backstage-debrief.firebasestorage.app", messagingSenderId: "313402258283", appId: "1:313402258283:web:5f6ce5828effa0a519d22e" };
  var db = null, auth = null;
  try { firebase.initializeApp(firebaseConfig); db = firebase.database(); auth = firebase.auth(); } catch(e) { console.warn("Firebase:", e); }
  window.RETRO_TEMPLATES = window.RETRO_TEMPLATES || {};
</script>
<script src="templates/backstage.js"></script>
<script src="templates/starwars.js"></script>
<script src="templates/gaming.js"></script>
<script src="templates/retro80.js"></script>
<script src="templates/kohlanta.js"></script>
<script type="text/babel">
const { useState, useEffect, useCallback, useRef } = React;

// ============================
// DEFAULT TEMPLATE
// ============================
const DEFAULT_SECTION_ORDER = ["header","regles","vibecheck","colonnes","saisie","roti","actions","resume","outro"];
const LOCKED_SECTIONS = ["header","resume","outro"];
const SECTION_LABELS = {header:"üîù Entr√©e (Header)",regles:"üìã R√®gles",vibecheck:"üé§ Ressenti",colonnes:"üìä Colonnes Feedbacks",saisie:"üí¨ Saisie Feedbacks",roti:"üìà ROTI",actions:"üéØ Actions",resume:"üèÜ R√©sum√©",outro:"üé¨ Mot de la Fin"};

const DEFAULT_TPL = { id:"custom-theme",name:"Mon Th√®me Custom",desc:"Un th√®me personnalis√©",preview:"üé®‚ú®üé≠",dark:false,appLogo:"",iconMeeting:"",iconStart:"",accent:"#F97316",accentDark:"#C2410C",accentLight:"#FFF7ED",bodyBg:"#F8EBDB",cardBg:"#FFFAF5",cardBorder:"#E8C9A8",inputBg:"#FFFAF5",inputBorder:"#E8C9A8",textPrimary:"#1F2937",textSecondary:"#6B7280",textMuted:"#9CA3AF",progressBg:"#FED7AA",appTitle:"MON TH√àME",subtitle:"R√©tro Sprint ‚Äî MyUnisoft GI",headerImage:"none",headerGradient:"linear-gradient(135deg, rgba(28,10,10,0.85) 0%, rgba(59,15,15,0.80) 40%, rgba(120,30,20,0.45) 100%)",rulesTitle:"üéº",rulesName:"R√®gles du Pitt",rulesColor:"#78350F",rulesDotColor:"#F97316",rulesImage:"none",rulesOverlayMobile:"linear-gradient(to bottom, #FFF6EE 0%, #FFF6EE 50%, rgba(255,246,238,0.7) 70%, rgba(255,246,238,0.3) 100%)",rulesOverlayDesktop:"linear-gradient(to right, #FFF6EE 0%, #FFF6EE 40%, rgba(255,246,238,0.7) 60%, rgba(255,246,238,0.2) 80%, transparent 100%)",rulesItems:["Ce qui se dit en r√©tro reste en r√©tro","Pas de jugement, que du feedback constructif","Tout le monde parle, personne ne domine","On cherche des solutions, pas des coupables","Les d√©cisions se prennent ensemble"],tooltip:{title:"LES R√àGLES DU GI CLUB",quote:"LA PREMI√àRE R√àGLE DU GI CLUB EST :\nON NE PARLE PAS DU GI CLUB EN DEHORS DU GI CLUB",author:"‚Äî Tyler Durden, probablement PO dans une autre vie",image:""},categories:[{id:"rock",label:"Rock",bg:"#DCFCE7"},{id:"fausse",label:"Fausse note",bg:"#FEE2E2"},{id:"ameliorer",label:"Am√©liorer",bg:"#DBEAFE"}],columns:{rock:{title:"üé∏ Rock",color:"#15803D",border:"#BBF7D0"},fausse:{title:"üéµ Fausse Note",color:"#DC2626",border:"#FECACA"},ameliorer:{title:"üîß Am√©liorer",color:"#2563EB",border:"#BFDBFE"}},vibeTitle:"üé§ Ressenti",vibeChecks:[{id:"ambiance",label:"Ambiance du Sprint",color:"#B45309",bg:"#FEF3C7",border:"#F59E0B",image:"",imageStyle:null},{id:"satisfaction",label:"Satisfaction Travail",color:"#7C3AED",bg:"#EDE9FE",border:"#8B5CF6",image:"",imageStyle:null}],roti:{id:"roti",label:"ROTI",color:"#C2410C",bg:"#FFEDD5",border:"#EA580C",image:"",imageStyle:null},ratingLabels:{1:{emoji:"üò§",label:"Catastrophe"},2:{emoji:"üòï",label:"Pas top"},3:{emoji:"üòê",label:"Moyen"},4:{emoji:"üòä",label:"Bien"},5:{emoji:"ü§©",label:"Excellent"}},ratingCatLabels:{ambiance:"Ambiance du Sprint",satisfaction:"Satisfaction Travail",roti:"ROTI"},feedbackTitle:"üí¨ Feedbacks",actionTitle:"üéØ Actions",actionQuote:"\"L'action est la cl√© du succ√®s.\"",afterTitle:"üìä R√©sultats & Actions",summaryTitle:"üèÜ R√©sum√© de la R√©tro",summaryImage:"none",summaryOverlay:"linear-gradient(135deg, rgba(28,10,10,0.88) 0%, rgba(50,14,14,0.92) 50%, rgba(28,10,10,0.88) 100%)",summaryPinHint:"Les retours üìå √©pingl√©s par l'admin appara√Ætront ici.",outroTitle:"üé¨ Le Mot de la Fin",outro:{none:{text:"En attente des votes...",emoji:"‚è≥"},low:{text:"Message basse moyenne",emoji:"üò¨"},mid:{text:"Message moyenne correcte",emoji:"üëç"},high:{text:"Message haute moyenne",emoji:"üéâ"}},outroGifs:{none:"",low:"",mid:"",high:""},mdTitle:"üé§ R√©tro Sprint",mdSummary:"üìä R√©sum√©",mdGlobal:"üéØ Moyenne globale",mdPinned:"üìå Retours √©pingl√©s",mdActions:"üéØ Actions",mdDetail:"üìã D√©tail des retours",sectionOrder:[...DEFAULT_SECTION_ORDER]};

// ============================
// PAINT-STYLE COLOR PALETTE
// ============================
const PAINT_COLORS = [
  // Row 1: Basic
  "#000000","#7F7F7F","#880015","#ED1C24","#FF7F27","#FFF200","#22B14C","#00A2E8","#3F48CC","#A349A4",
  // Row 2: Lighter
  "#FFFFFF","#C3C3C3","#B97A57","#FFAEC9","#FFC90E","#EFE4B0","#B5E61D","#99D9EA","#7092BE","#C8BFE7",
  // Row 3: Extended
  "#1B1464","#2E3192","#0054A6","#2B388F","#00AEEF","#6DCFF6","#00A651","#39B54A","#8DC63F","#D9E021",
  // Row 4: Warm extended
  "#F26522","#F7941D","#FBB03B","#FCB040","#F15A24","#BE1E2D","#93278F","#662D91","#9E005D","#C1272D",
  // Row 5: Pastels
  "#FDE8E8","#FCE4EC","#F3E5F5","#EDE7F6","#E8EAF6","#E3F2FD","#E0F7FA","#E0F2F1","#E8F5E9","#FFF8E1",
  // Row 6: Dark variants
  "#1A1A2E","#16213E","#0F3460","#1B262C","#222831","#2C3333","#1A3C40","#2C3639","#3C2A21","#3E065F"
];

// ============================
// COLOR PICKER COMPONENT
// ============================
function ColorPickerPopup({ value, onChange, onClose }) {
  const [hex, setHex] = useState(value || "#F97316");
  const [r, setR] = useState(249); const [g, setG] = useState(115); const [b, setB] = useState(22);
  const spectrumRef = useRef(null);
  const hueRef = useRef(null);
  const [hue, setHue] = useState(0);
  const [sat, setSat] = useState(100);
  const [light, setLight] = useState(50);

  useEffect(() => {
    const c = value || "#F97316";
    setHex(c);
    const rgb = hexToRgb(c);
    if (rgb) { setR(rgb.r); setG(rgb.g); setB(rgb.b);
      const hsl = rgbToHsl(rgb.r, rgb.g, rgb.b);
      setHue(hsl.h); setSat(hsl.s); setLight(hsl.l);
    }
  }, []);

  function hexToRgb(h) {
    const m = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(h);
    return m ? { r: parseInt(m[1], 16), g: parseInt(m[2], 16), b: parseInt(m[3], 16) } : null;
  }
  function rgbToHex(r,g,b) { return "#" + [r,g,b].map(x => x.toString(16).padStart(2,"0")).join(""); }
  function rgbToHsl(r,g,b) {
    r/=255;g/=255;b/=255;const mx=Math.max(r,g,b),mn=Math.min(r,g,b);let h,s,l=(mx+mn)/2;
    if(mx===mn){h=s=0;}else{const d=mx-mn;s=l>0.5?d/(2-mx-mn):d/(mx+mn);
      switch(mx){case r:h=((g-b)/d+(g<b?6:0))/6;break;case g:h=((b-r)/d+2)/6;break;case b:h=((r-g)/d+4)/6;break;}
    }
    return{h:Math.round(h*360),s:Math.round(s*100),l:Math.round(l*100)};
  }
  function hslToRgb(h,s,l) {
    h/=360;s/=100;l/=100;let r,g,b;
    if(s===0){r=g=b=l;}else{
      const q=l<0.5?l*(1+s):l+s-l*s,p=2*l-q;
      function hue2rgb(p,q,t){if(t<0)t+=1;if(t>1)t-=1;if(t<1/6)return p+(q-p)*6*t;if(t<1/2)return q;if(t<2/3)return p+(q-p)*(2/3-t)*6;return p;}
      r=hue2rgb(p,q,h+1/3);g=hue2rgb(p,q,h);b=hue2rgb(p,q,h-1/3);
    }
    return{r:Math.round(r*255),g:Math.round(g*255),b:Math.round(b*255)};
  }

  const updateFromHSL = (h, s, l) => {
    const rgb = hslToRgb(h, s, l);
    setR(rgb.r); setG(rgb.g); setB(rgb.b);
    setHex(rgbToHex(rgb.r, rgb.g, rgb.b));
  };

  const handleSpectrumClick = (e) => {
    const rect = spectrumRef.current.getBoundingClientRect();
    const x = Math.max(0, Math.min(1, (e.clientX - rect.left) / rect.width));
    const y = Math.max(0, Math.min(1, (e.clientY - rect.top) / rect.height));
    const newSat = Math.round(x * 100);
    const newLight = Math.round((1 - y) * 100);
    setSat(newSat); setLight(newLight);
    updateFromHSL(hue, newSat, newLight);
  };
  const handleHueClick = (e) => {
    const rect = hueRef.current.getBoundingClientRect();
    const x = Math.max(0, Math.min(1, (e.clientX - rect.left) / rect.width));
    const newHue = Math.round(x * 360);
    setHue(newHue);
    updateFromHSL(newHue, sat, light);
  };
  const handleHexInput = (v) => {
    setHex(v);
    const rgb = hexToRgb(v);
    if (rgb) { setR(rgb.r); setG(rgb.g); setB(rgb.b);
      const hsl = rgbToHsl(rgb.r, rgb.g, rgb.b);
      setHue(hsl.h); setSat(hsl.s); setLight(hsl.l);
    }
  };
  const handlePalette = (c) => { handleHexInput(c); };
  const confirm = () => { onChange(hex); onClose(); };

  const spectrumBg = `linear-gradient(to right, hsl(${hue},0%,50%), hsl(${hue},100%,50%))`;

  return (
    <div className="cpk-overlay" onClick={onClose}>
      <div className="cpk-popup" onClick={e => e.stopPropagation()}>
        <div style={{fontSize:13,fontWeight:700,color:"#F97316",marginBottom:12,display:"flex",justifyContent:"space-between",alignItems:"center"}}>
          <span>üé® S√©lecteur de couleur</span>
          <button onClick={onClose} style={{background:"none",border:"none",color:"#555",fontSize:18,cursor:"pointer"}}>‚úï</button>
        </div>

        {/* Spectrum: saturation x lightness */}
        <div ref={spectrumRef} className="cpk-spectrum" onClick={handleSpectrumClick}
          onMouseDown={(e) => { handleSpectrumClick(e); const move = (ev) => handleSpectrumClick(ev); const up = () => { document.removeEventListener("mousemove",move); document.removeEventListener("mouseup",up); }; document.addEventListener("mousemove",move); document.addEventListener("mouseup",up); }}
          style={{background:`linear-gradient(to bottom, white, transparent, black), linear-gradient(to right, gray, hsl(${hue},100%,50%))`, backgroundBlendMode:"normal"}}>
          <div style={{position:"absolute",left:`${sat}%`,top:`${100-light}%`,width:12,height:12,borderRadius:"50%",border:"2px solid white",boxShadow:"0 0 4px rgba(0,0,0,0.5)",transform:"translate(-50%,-50%)",pointerEvents:"none"}}/>
        </div>

        {/* Hue bar */}
        <div style={{fontSize:10,color:"#555",fontWeight:600,marginBottom:3}}>Teinte (Hue)</div>
        <div ref={hueRef} className="cpk-hue-bar" onClick={handleHueClick}
          onMouseDown={(e) => { handleHueClick(e); const move = (ev) => handleHueClick(ev); const up = () => { document.removeEventListener("mousemove",move); document.removeEventListener("mouseup",up); }; document.addEventListener("mousemove",move); document.addEventListener("mouseup",up); }}
          style={{background:"linear-gradient(to right, #ff0000, #ffff00, #00ff00, #00ffff, #0000ff, #ff00ff, #ff0000)", position:"relative"}}>
          <div style={{position:"absolute",left:`${hue/360*100}%`,top:"50%",width:6,height:20,borderRadius:3,border:"2px solid white",boxShadow:"0 0 4px rgba(0,0,0,0.4)",transform:"translate(-50%,-50%)",pointerEvents:"none",background:`hsl(${hue},100%,50%)`}}/>
        </div>

        {/* Paint-style palette */}
        <div style={{fontSize:10,color:"#555",fontWeight:600,marginBottom:4,marginTop:8}}>Palette rapide</div>
        <div className="cpk-palette">
          {PAINT_COLORS.map((c,i) => (
            <button key={i} onClick={() => handlePalette(c)} style={{background:c, borderColor: hex.toLowerCase()===c.toLowerCase() ? "#F97316" : "#333", borderWidth: hex.toLowerCase()===c.toLowerCase() ? 2 : 1}} title={c}/>
          ))}
        </div>

        {/* Inputs */}
        <div style={{fontSize:10,color:"#555",fontWeight:600,marginBottom:4}}>Valeur</div>
        <div className="cpk-inputs">
          <div style={{flex:2}}><input value={hex} onChange={e => handleHexInput(e.target.value)} placeholder="#RRGGBB" style={{fontFamily:"monospace"}}/></div>
          <div style={{flex:1,textAlign:"center"}}><div style={{fontSize:9,color:"#555",marginBottom:2}}>R</div><input value={r} onChange={e => { const v=Math.min(255,Math.max(0,parseInt(e.target.value)||0)); setR(v); const h2=rgbToHex(v,g,b); setHex(h2); const hsl=rgbToHsl(v,g,b); setHue(hsl.h);setSat(hsl.s);setLight(hsl.l);}} style={{textAlign:"center",fontFamily:"monospace"}}/></div>
          <div style={{flex:1,textAlign:"center"}}><div style={{fontSize:9,color:"#555",marginBottom:2}}>G</div><input value={g} onChange={e => { const v=Math.min(255,Math.max(0,parseInt(e.target.value)||0)); setG(v); const h2=rgbToHex(r,v,b); setHex(h2); const hsl=rgbToHsl(r,v,b); setHue(hsl.h);setSat(hsl.s);setLight(hsl.l);}} style={{textAlign:"center",fontFamily:"monospace"}}/></div>
          <div style={{flex:1,textAlign:"center"}}><div style={{fontSize:9,color:"#555",marginBottom:2}}>B</div><input value={b} onChange={e => { const v=Math.min(255,Math.max(0,parseInt(e.target.value)||0)); setB(v); const h2=rgbToHex(r,g,v); setHex(h2); const hsl=rgbToHsl(r,g,v); setHue(hsl.h);setSat(hsl.s);setLight(hsl.l);}} style={{textAlign:"center",fontFamily:"monospace"}}/></div>
        </div>

        {/* Preview */}
        <div className="cpk-preview" style={{background:hex}}/>

        <div className="cpk-btns">
          <button onClick={onClose} style={{background:"none",border:"1px solid #444",color:"#aaa"}}>Annuler</button>
          <button onClick={confirm} style={{background:"linear-gradient(135deg,#F97316,#EA580C)",border:"none",color:"#fff"}}>Appliquer</button>
        </div>
      </div>
    </div>
  );
}

// ============================
// FORM COMPONENTS
// ============================
function CF({label,value,onChange,tooltip}) {
  const [showPicker, setShowPicker] = useState(false);
  const [showTip, setShowTip] = useState(false);
  const [tipPos, setTipPos] = useState({top:0,left:0});
  const tipRef = React.useRef(null);
  const handleEnter = () => {
    if(tipRef.current){
      const r = tipRef.current.getBoundingClientRect();
      setTipPos({top: r.top - 4, left: r.right + 10});
    }
    setShowTip(true);
  };
  return (
    <div className="field"><label style={{display:"flex",alignItems:"center",gap:4}}>
      {label}
      {tooltip && <span ref={tipRef} onMouseEnter={handleEnter} onMouseLeave={()=>setShowTip(false)} style={{cursor:"help",fontSize:12,color:"#888",lineHeight:1}}>‚ìò
        {showTip && ReactDOM.createPortal(<span style={{position:"fixed",top:tipPos.top,left:tipPos.left,background:"#EFEFEF",color:"#1A1A1A",fontSize:11,padding:"8px 12px",borderRadius:8,whiteSpace:"normal",width:250,lineHeight:1.5,boxShadow:"0 4px 16px rgba(0,0,0,0.3)",border:"1px solid #bbb",zIndex:9999,fontWeight:400,pointerEvents:"none"}}>{tooltip}</span>, document.body)}
      </span>}
    </label>
      <div className="color-field">
        <div onClick={() => setShowPicker(true)} style={{width:32,height:32,borderRadius:6,border:"2px solid #333",background:value||"#000",cursor:"pointer",flexShrink:0}} title="Ouvrir le s√©lecteur"/>
        <input type="text" value={value||""} onChange={e=>onChange(e.target.value)} placeholder="#RRGGBB ou rgba(...)"/>
      </div>
      {showPicker && <ColorPickerPopup value={value} onChange={onChange} onClose={() => setShowPicker(false)}/>}
    </div>
  );
}
function TF({label,value,onChange,placeholder,multiline}){return(<div className="field"><label>{label}</label>{multiline?<textarea value={value||""} onChange={e=>onChange(e.target.value)} placeholder={placeholder}/>:<input type="text" value={value||""} onChange={e=>onChange(e.target.value)} placeholder={placeholder}/>}</div>);}
// Context pour passer l'ID du th√®me aux composants ImageField

// Composant image avec import local base64 + preview + delete
function ImageField({label,value,onChange,cssUrl}){
  const fileRef = React.useRef(null);

  // Extraire l'URL brute si format css url("...")
  const rawUrl = React.useMemo(() => {
    if(!value) return "";
    if(cssUrl){const m=value.match(/url\(["']?([^"')]+)["']?\)/);return m?m[1]:value;}
    return value;
  },[value,cssUrl]);

  const handleFile = (e) => {
    const file = e.target.files?.[0];
    if(!file) return;
    // Limite 500 Ko pour ne pas alourdir la base
    if(file.size > 500*1024){alert("Image trop lourde (max 500 Ko). Redimensionne-la ou compresse-la avant.");e.target.value="";return;}
    const reader = new FileReader();
    reader.onload = (ev) => {
      const b64 = ev.target.result;
      onChange(cssUrl ? 'url("'+b64+'")' : b64);
    };
    reader.readAsDataURL(file);
    e.target.value = "";
  };

  const handleDelete = () => {
    onChange(cssUrl ? "none" : "");
  };

  return(
    <div className="field">
      <label>{label}</label>
      <div className="uf-wrap">
        <div className="uf-row">
          {rawUrl && rawUrl!=="none" && !rawUrl.startsWith("data:") && <img className="uf-preview" src={rawUrl} onError={e=>e.target.style.display="none"} alt=""/>}
          {rawUrl && rawUrl.startsWith("data:") && <img className="uf-preview" src={rawUrl} alt=""/>}
          <input type="text" value={value && !value.startsWith("data:") && !(cssUrl && value.includes("data:")) ? value : (rawUrl.startsWith("data:") ? "üìé Image import√©e" : value||"")} onChange={e=>onChange(e.target.value)} placeholder={cssUrl ? 'url("...") ou none' : "https://... ou vide"} readOnly={rawUrl.startsWith("data:")}/>
          <button className="uf-btn" onClick={()=>fileRef.current?.click()} title="Importer depuis le PC (max 500 Ko)">üìÅ</button>
          {rawUrl && rawUrl!=="none" && <button className="uf-btn danger" onClick={handleDelete} title="Supprimer l'image">üóëÔ∏è</button>}
        </div>
        <input ref={fileRef} type="file" accept="image/*,.gif" style={{display:"none"}} onChange={handleFile}/>
      </div>
    </div>
  );
}

function Collapsible({title, defaultOpen, children}) {
  const [open, setOpen] = useState(defaultOpen !== false);
  return (
    <div>
      <div className="collapse-header" onClick={() => setOpen(!open)}>
        <div className="section-title">{title}</div>
        <span className={`collapse-chevron ${open ? "open" : ""}`}>‚ñ∂</span>
      </div>
      <div className={`collapse-body ${open ? "open" : "closed"}`}>{children}</div>
    </div>
  );
}

// ============================
// GRADIENT BUILDER
// ============================
function parseGradient(str) {
  if (!str || !str.includes("gradient")) return null;
  try {
    const match = str.match(/linear-gradient\(([^,]+),\s*(.*)\)/s);
    if (!match) return null;
    const direction = match[1].trim();
    const stopsStr = match[2];
    const stops = [];
    const re = /(rgba?\([^)]+\)|#[a-fA-F0-9]{3,8}|[a-z]+)\s*(\d+%)?/g;
    let m;
    while ((m = re.exec(stopsStr)) !== null) {
      stops.push({ color: m[1], position: m[2] || "" });
    }
    return { direction, stops: stops.length ? stops : [{ color: "#000000", position: "0%" }, { color: "#ffffff", position: "100%" }] };
  } catch (e) { return null; }
}

function buildGradient(parsed) {
  if (!parsed) return "";
  const stopsStr = parsed.stops.map(s => `${s.color} ${s.position}`).join(", ");
  return `linear-gradient(${parsed.direction}, ${stopsStr})`;
}

function GradientBuilder({ label, description, value, onChange }) {
  const parsed = parseGradient(value);
  const [editMode, setEditMode] = useState(!parsed ? "raw" : "visual");

  if (editMode === "raw" || !parsed) {
    return (
      <div className="field">
        <label style={{display:"flex",justifyContent:"space-between",alignItems:"center"}}>
          {label}
          {parsed && <button onClick={() => setEditMode("visual")} style={{fontSize:9,background:"#261A0F",border:"1px solid #F97316",color:"#F97316",borderRadius:4,padding:"2px 6px",cursor:"pointer",fontFamily:"inherit"}}>Mode visuel</button>}
        </label>
        {description && <div className="section-desc">{description}</div>}
        <textarea value={value||""} onChange={e=>onChange(e.target.value)} placeholder="linear-gradient(...)"/>
        <div className="grad-preview" style={{background:value||"#333"}}/>
      </div>
    );
  }

  const updateDirection = (d) => { const p = {...parsed, direction: d}; onChange(buildGradient(p)); };
  const updateStop = (i, key, val) => { const p = {...parsed, stops: parsed.stops.map((s,j) => j===i ? {...s,[key]:val} : s)}; onChange(buildGradient(p)); };
  const addStop = () => { const p = {...parsed, stops: [...parsed.stops, {color:"rgba(0,0,0,0.5)",position:"50%"}]}; onChange(buildGradient(p)); };
  const removeStop = (i) => { if (parsed.stops.length <= 2) return; const p = {...parsed, stops: parsed.stops.filter((_,j) => j!==i)}; onChange(buildGradient(p)); };

  return (
    <div className="field">
      <label style={{display:"flex",justifyContent:"space-between",alignItems:"center"}}>
        {label}
        <button onClick={() => setEditMode("raw")} style={{fontSize:9,background:"#1A1A1A",border:"1px solid #444",color:"#888",borderRadius:4,padding:"2px 6px",cursor:"pointer",fontFamily:"inherit"}}>Mode brut</button>
      </label>
      {description && <div className="section-desc">{description}</div>}

      <div style={{marginBottom:6}}>
        <div style={{fontSize:10,color:"#666",marginBottom:3,fontWeight:600}}>Direction du d√©grad√©</div>
        <div style={{display:"flex",gap:4,flexWrap:"wrap",marginBottom:4}}>
          {[{v:"to bottom",l:"‚Üì Haut‚ÜíBas"},{v:"to right",l:"‚Üí Gauche‚ÜíDroite"},{v:"to top",l:"‚Üë Bas‚ÜíHaut"},{v:"to left",l:"‚Üê Droite‚ÜíGauche"},{v:"135deg",l:"‚Üò Diag. 135¬∞"},{v:"45deg",l:"‚Üó Diag. 45¬∞"}].map(d => (
            <button key={d.v} onClick={() => updateDirection(d.v)} style={{
              padding:"3px 8px",borderRadius:4,fontSize:10,cursor:"pointer",fontFamily:"inherit",fontWeight:600,
              border: parsed.direction === d.v ? "1px solid #F97316" : "1px solid #333",
              background: parsed.direction === d.v ? "#261A0F" : "#111",
              color: parsed.direction === d.v ? "#F97316" : "#888"
            }}>{d.l}</button>
          ))}
        </div>
        <input type="text" value={parsed.direction} onChange={e => updateDirection(e.target.value)} style={{padding:"5px 8px",borderRadius:4,border:"1px solid #333",background:"#111",color:"#ccc",fontSize:11,fontFamily:"inherit",width:"100%"}} placeholder="Direction personnalis√©e (ex: 135deg, to bottom right...)"/>
      </div>

      <div style={{fontSize:10,color:"#666",marginBottom:3,fontWeight:600}}>√âtapes du d√©grad√© ({parsed.stops.length})</div>
      <div style={{fontSize:9,color:"#999",marginBottom:6,fontStyle:"italic"}}>Chaque √©tape = une couleur positionn√©e sur l'axe. 0% = d√©but, 100% = fin. Le rgba(r,g,b,opacit√©) permet la transparence.</div>
      <div style={{display:"flex",gap:6,marginBottom:4,padding:"0 0 0 22px"}}>
        <span style={{flex:2,fontSize:9,color:"#555",fontWeight:600}}>Couleur (hex ou rgba)</span>
        <span style={{width:55,fontSize:9,color:"#555",fontWeight:600,textAlign:"center"}}>Position</span>
        <span style={{width:26}}/>
      </div>
      {parsed.stops.map((stop, i) => (
        <div key={i} className="grad-stop">
          <span style={{fontSize:10,color:"#555",fontWeight:700,width:16,textAlign:"center"}}>{i+1}</span>
          <input type="text" value={stop.color} onChange={e => updateStop(i,"color",e.target.value)} style={{flex:2}} placeholder="rgba(28,10,10,0.85) ou #1C0A0A"/>
          <input type="text" value={stop.position} onChange={e => updateStop(i,"position",e.target.value)} style={{width:55,textAlign:"center"}} placeholder="50%"/>
          {parsed.stops.length > 2 && <button className="btn-remove" onClick={() => removeStop(i)} style={{fontSize:12,padding:"0 4px"}}>‚úï</button>}
        </div>
      ))}
      <button className="btn-add" onClick={addStop} style={{fontSize:10,padding:"5px 0",marginTop:2}}>+ Ajouter une √©tape</button>
      <div className="grad-preview" style={{background:value||"#333"}}/>
    </div>
  );
}

// ============================
// SECTION REORDER (Drag & Drop)
// ============================
function SectionReorder({ order, onChange }) {
  const [dragIdx, setDragIdx] = useState(null);
  const [overIdx, setOverIdx] = useState(null);

  const handleDragStart = (i) => {
    if (LOCKED_SECTIONS.includes(order[i])) return;
    setDragIdx(i);
  };
  const handleDragOver = (e, i) => {
    e.preventDefault();
    if (LOCKED_SECTIONS.includes(order[i])) return;
    setOverIdx(i);
  };
  const handleDrop = (i) => {
    if (dragIdx === null || LOCKED_SECTIONS.includes(order[i]) || LOCKED_SECTIONS.includes(order[dragIdx])) { setDragIdx(null); setOverIdx(null); return; }
    const newOrder = [...order];
    const [moved] = newOrder.splice(dragIdx, 1);
    newOrder.splice(i, 0, moved);
    onChange(newOrder);
    setDragIdx(null); setOverIdx(null);
  };

  return (
    <div>
      <div className="section-title" style={{marginTop:0}}>Ordre des sections</div>
      <div className="section-desc">Glisse-d√©pose les sections pour r√©organiser. Les sections verrouill√©es (üîí) restent fixes.</div>
      {order.map((id, i) => {
        const locked = LOCKED_SECTIONS.includes(id);
        return (
          <div key={id}
            className={`reorder-item ${locked ? "locked" : ""} ${dragIdx === i ? "dragging" : ""} ${overIdx === i && dragIdx !== i ? "drag-over" : ""}`}
            draggable={!locked}
            onDragStart={() => handleDragStart(i)}
            onDragOver={(e) => handleDragOver(e, i)}
            onDrop={() => handleDrop(i)}
            onDragEnd={() => { setDragIdx(null); setOverIdx(null); }}
          >
            <span className="reorder-handle">{locked ? "üîí" : "‚†ø"}</span>
            <span className="reorder-label">{SECTION_LABELS[id] || id}</span>
            {locked && <span className="reorder-lock">Fixe</span>}
          </div>
        );
      })}
    </div>
  );
}

// ============================
// TABS (Ordre calqu√© sur backstage.js)
// ============================
function TabIdentite({t,set}){return(<><Collapsible title="Identit√©"><TF label="ID unique" value={t.id} onChange={v=>set("id",v.toLowerCase().replace(/[^a-z0-9-]/g,""))}/><TF label="Nom" value={t.name} onChange={v=>set("name",v)}/><TF label="Description" value={t.desc} onChange={v=>set("desc",v)}/><TF label="Emojis aper√ßu" value={t.preview} onChange={v=>set("preview",v)}/><div className="toggle-row"><span className="toggle-label">Adapter au mode sombre</span><button className={`toggle ${t.dark?"on":"off"}`} onClick={()=>set("dark",!t.dark)}/></div></Collapsible><Collapsible title="Images de l'app" defaultOpen={false}><div className="section-desc">Logo et ic√¥nes affich√©s dans le header et les boutons. Laisser vide pour garder les images par d√©faut.</div><ImageField label="Logo / Mascotte" value={t.appLogo} onChange={v=>set("appLogo",v)}/><ImageField label="Ic√¥ne r√©union" value={t.iconMeeting} onChange={v=>set("iconMeeting",v)}/><ImageField label="Ic√¥ne d√©marrer" value={t.iconStart} onChange={v=>set("iconStart",v)}/></Collapsible></>);}

function TabCouleurs({t,set}){return(<><Collapsible title="Principales"><CF label="Accent" tooltip="Couleur star : titre header, boutons Ajouter, bordure Actions, compteur /3, titre R√©sum√©, titre Outro, glow des votes" value={t.accent} onChange={v=>set("accent",v)}/><CF label="Accent fonc√©" tooltip="2e couleur du d√©grad√© des boutons Ajouter, titre Actions en mode clair" value={t.accentDark} onChange={v=>set("accentDark",v)}/><CF label="Accent clair" tooltip="Fond des items d'action, fond des cartes de th√®me s√©lectionn√©es dans le picker" value={t.accentLight} onChange={v=>set("accentLight",v)}/></Collapsible><Collapsible title="Arri√®re-plans"><CF label="Body" tooltip="Fond de toute la page, visible derri√®re les cartes" value={t.bodyBg} onChange={v=>set("bodyBg",v)}/><CF label="Cartes" tooltip="Fond des cartes : Ressenti, colonnes feedbacks, carte ROTI, carte Actions, cercles de vote non s√©lectionn√©s" value={t.cardBg} onChange={v=>set("cardBg",v)}/><CF label="Bordures" tooltip="Bordure neutre du conteneur Ressenti (bordure de structure)" value={t.cardBorder} onChange={v=>set("cardBorder",v)}/><CF label="Inputs" tooltip="Fond des champs de saisie : input feedback et inputs action/responsable" value={t.inputBg} onChange={v=>set("inputBg",v)}/><CF label="Inputs bord." tooltip="Bordure des inputs au repos (avant focus) et bordure des cercles emoji de vote non s√©lectionn√©s" value={t.inputBorder} onChange={v=>set("inputBorder",v)}/><CF label="Progress" tooltip="Fond de la barre de progression des r√©sultats de vote (barre grise derri√®re la barre color√©e)" value={t.progressBg} onChange={v=>set("progressBg",v)}/></Collapsible><Collapsible title="Textes"><CF label="Primaire" tooltip="Texte principal : titres de section, texte des feedbacks, items de r√®gles, texte des actions, couleur de frappe" value={t.textPrimary} onChange={v=>set("textPrimary",v)}/><CF label="Secondaire" tooltip="Texte d'importance moyenne : label ¬´ / 5 ‚Äî Bien ¬ª sous les r√©sultats, texte des r√®gles en mode sombre" value={t.textSecondary} onChange={v=>set("textSecondary",v)}/><CF label="Att√©nu√©" tooltip="Texte discret : ¬´ Aucun retour ¬ª, ¬´ Choisis ton emoji pour voter ¬ª, compteur de votes, nombre de votants" value={t.textMuted} onChange={v=>set("textMuted",v)}/></Collapsible></>);}

function TabHeader({t,set}){return(<><Collapsible title="Entr√©e (Header)"><div className="section-desc">Le bandeau en haut de la r√©tro avec titre et image de fond.</div><TF label="Titre" value={t.appTitle} onChange={v=>set("appTitle",v)}/><TF label="Sous-titre" value={t.subtitle} onChange={v=>set("subtitle",v)}/><ImageField label="Image de fond" cssUrl value={t.headerImage} onChange={v=>set("headerImage",v)}/><GradientBuilder label="Gradient overlay" description="D√©grad√© appliqu√© par-dessus l'image de fond du header." value={t.headerGradient} onChange={v=>set("headerGradient",v)}/></Collapsible></>);}

function TabRegles({t,set}){const sT=(k,v)=>set("tooltip",{...t.tooltip,[k]:v});const uR=(i,v)=>{const a=[...t.rulesItems];a[i]=v;set("rulesItems",a);};return(<><Collapsible title="Apparence des r√®gles"><div className="section-desc">Style visuel du bloc r√®gles affich√© sous le header.</div><div className="field-row"><TF label="Emoji" value={t.rulesTitle} onChange={v=>set("rulesTitle",v)}/><TF label="Nom" value={t.rulesName} onChange={v=>set("rulesName",v)}/></div><CF label="Couleur titre" value={t.rulesColor} onChange={v=>set("rulesColor",v)}/><CF label="Puces" value={t.rulesDotColor} onChange={v=>set("rulesDotColor",v)}/><ImageField label="Image de fond" cssUrl value={t.rulesImage} onChange={v=>set("rulesImage",v)}/><GradientBuilder label="Overlay mobile" description="D√©grad√© appliqu√© sur l'image de fond en version mobile (typiquement de haut en bas)." value={t.rulesOverlayMobile} onChange={v=>set("rulesOverlayMobile",v)}/><GradientBuilder label="Overlay desktop" description="D√©grad√© appliqu√© sur l'image de fond en version desktop (typiquement de gauche √† droite)." value={t.rulesOverlayDesktop} onChange={v=>set("rulesOverlayDesktop",v)}/></Collapsible><Collapsible title={`Liste des r√®gles (${t.rulesItems.length})`}><div className="section-desc">Les textes affich√©s comme r√®gles de la r√©tro.</div>{t.rulesItems.map((r,i)=>(<div key={i} style={{display:"flex",gap:6,marginBottom:6}}><input type="text" value={r} onChange={e=>uR(i,e.target.value)} style={{flex:1,padding:"6px 10px",borderRadius:6,border:"1px solid #333",background:"#1A1A1A",color:"#E5E5E5",fontSize:12,fontFamily:"inherit"}}/><button className="btn-remove" onClick={()=>set("rulesItems",t.rulesItems.filter((_,j)=>j!==i))}>‚úï</button></div>))}<button className="btn-add" onClick={()=>set("rulesItems",[...t.rulesItems,"Nouvelle r√®gle"])}>+ Ajouter</button></Collapsible><Collapsible title="Tooltip des r√®gles" defaultOpen={false}><div className="section-desc">Bulle affich√©e au survol du titre des r√®gles.</div><TF label="Titre" value={t.tooltip.title} onChange={v=>sT("title",v)}/><TF label="Citation" value={t.tooltip.quote} onChange={v=>sT("quote",v)} multiline/><TF label="Auteur" value={t.tooltip.author} onChange={v=>sT("author",v)}/><ImageField label="Image du tooltip" value={t.tooltip.image} onChange={v=>sT("image",v)}/></Collapsible></>);}

function TabVibeCheck({t,set}){const uV=(i,k,v)=>{const vs=[...t.vibeChecks];vs[i]={...vs[i],[k]:v};set("vibeChecks",vs);};return(<><Collapsible title="Ressenti"><div className="section-desc">Les votes d'ambiance et satisfaction (avant les feedbacks).</div><TF label="Titre section" value={t.vibeTitle} onChange={v=>set("vibeTitle",v)}/>{t.vibeChecks.map((vc,i)=>(<div key={i} className="array-item"><div className="array-item-title" style={{marginBottom:8}}>üé§ {vc.label || vc.id}</div><TF label="Label" value={vc.label} onChange={v=>uV(i,"label",v)}/><div className="field-row"><CF label="Couleur texte" value={vc.color} onChange={v=>uV(i,"color",v)}/><CF label="Fond s√©lection" value={vc.bg} onChange={v=>uV(i,"bg",v)}/></div><CF label="Bordure" value={vc.border} onChange={v=>uV(i,"border",v)}/><ImageField label="Image" value={vc.image} onChange={v=>uV(i,"image",v)}/></div>))}</Collapsible><Collapsible title="Labels de vote (1-5)" defaultOpen={false}><div className="section-desc">Emojis et textes pour chaque note de 1 √† 5.</div>{[1,2,3,4,5].map(n=>(<div key={n} className="emoji-grid"><span className="num">{n}</span><input type="text" value={t.ratingLabels[n]?.emoji||""} onChange={e=>set("ratingLabels",{...t.ratingLabels,[n]:{...t.ratingLabels[n],emoji:e.target.value}})} style={{padding:"6px 8px",borderRadius:6,border:"1px solid #333",background:"#1A1A1A",color:"#E5E5E5",fontSize:14,fontFamily:"inherit",textAlign:"center"}}/><input type="text" value={t.ratingLabels[n]?.label||""} onChange={e=>set("ratingLabels",{...t.ratingLabels,[n]:{...t.ratingLabels[n],label:e.target.value}})} style={{padding:"6px 8px",borderRadius:6,border:"1px solid #333",background:"#1A1A1A",color:"#E5E5E5",fontSize:12,fontFamily:"inherit"}}/></div>))}</Collapsible></>);}

function TabColonnes({t,set}){const uC=(i,k,v)=>{const c=[...t.categories];c[i]={...c[i],[k]:v};set("categories",c);};const uCol=(id,k,v)=>set("columns",{...t.columns,[id]:{...t.columns[id],[k]:v}});return(<><Collapsible title={`Colonnes Feedbacks (${t.categories.length})`}><div className="section-desc">Les colonnes o√π les participants d√©posent leurs retours.</div><TF label="Titre feedbacks" value={t.feedbackTitle} onChange={v=>set("feedbackTitle",v)}/>{t.categories.map((cat,i)=>(<div key={i} className="array-item"><div className="array-item-header"><span className="array-item-title">{t.columns[cat.id]?.title || cat.id}</span>{t.categories.length>2&&<button className="btn-remove" onClick={()=>{const c={...t.columns};delete c[cat.id];set("categories",t.categories.filter((_,j)=>j!==i));set("columns",c);}}>‚úï</button>}</div><div className="field-row"><TF label="ID" value={cat.id} onChange={v=>{const old=cat.id;const c={...t.columns};c[v]=c[old];delete c[old];uC(i,"id",v);set("columns",c);}}/><TF label="Label bouton" value={cat.label} onChange={v=>uC(i,"label",v)}/></div><TF label="Titre colonne" value={t.columns[cat.id]?.title||""} onChange={v=>uCol(cat.id,"title",v)}/><div className="field-row"><CF label="Couleur titre" tooltip="Couleur du titre de la colonne et du texte" value={t.columns[cat.id]?.color} onChange={v=>uCol(cat.id,"color",v)}/><CF label="Bordure colonne" tooltip="Bordure de la colonne de feedbacks" value={t.columns[cat.id]?.border} onChange={v=>uCol(cat.id,"border",v)}/></div><CF label="Fond carte retour" tooltip="Fond des cartes de feedback dans la colonne" value={cat.bg||""} onChange={v=>uC(i,"bg",v)}/><div className="field-row"><CF label="Fond bouton s√©lectionn√©" tooltip="Couleur de fond du bouton de cat√©gorie quand il est actif" value={cat.btnActive||t.columns[cat.id]?.color||""} onChange={v=>uC(i,"btnActive",v)}/><CF label="Fond bouton non s√©lectionn√©" tooltip="Couleur de fond du bouton de cat√©gorie quand il est inactif" value={cat.btnInactive||t.columns[cat.id]?.border||""} onChange={v=>uC(i,"btnInactive",v)}/></div><div className="field-row"><CF label="Bordure bouton s√©lectionn√©" tooltip="Couleur de bordure du bouton quand actif" value={cat.btnBorderActive||cat.btnActive||t.columns[cat.id]?.color||""} onChange={v=>uC(i,"btnBorderActive",v)}/><CF label="Bordure bouton non s√©lectionn√©" tooltip="Couleur de bordure du bouton quand inactif" value={cat.btnBorderInactive||cat.btnInactive||t.columns[cat.id]?.border||""} onChange={v=>uC(i,"btnBorderInactive",v)}/></div><div className="field-row"><CF label="Texte bouton s√©lectionn√©" tooltip="Couleur du texte du bouton quand actif" value={cat.btnTextActive||"#ffffff"} onChange={v=>uC(i,"btnTextActive",v)}/><CF label="Texte bouton non s√©lectionn√©" tooltip="Couleur du texte du bouton quand inactif" value={cat.btnTextInactive||t.columns[cat.id]?.color||""} onChange={v=>uC(i,"btnTextInactive",v)}/></div></div>))}{t.categories.length<5&&<button className="btn-add" onClick={()=>{const id="cat"+(t.categories.length+1);set("categories",[...t.categories,{id,label:"Nouveau",bg:"#F3F4F6",border:"#E5E7EB"}]);set("columns",{...t.columns,[id]:{title:"üÜï Nouveau",color:"#6B7280",border:"#E5E7EB"}});}}>+ Ajouter</button>}</Collapsible></>);}

function TabRoti({t,set}){return(<><Collapsible title="ROTI"><div className="section-desc">Le vote ROTI (Return On Time Invested), affich√© √† c√¥t√© des actions.</div><div className="array-item"><TF label="Label" value={t.roti.label} onChange={v=>set("roti",{...t.roti,label:v})}/><div className="field-row"><CF label="Couleur texte" value={t.roti.color} onChange={v=>set("roti",{...t.roti,color:v})}/><CF label="Fond s√©lection" value={t.roti.bg} onChange={v=>set("roti",{...t.roti,bg:v})}/></div><CF label="Bordure" value={t.roti.border} onChange={v=>set("roti",{...t.roti,border:v})}/><ImageField label="Image" value={t.roti.image} onChange={v=>set("roti",{...t.roti,image:v})}/></div><TF label="Titre section (affich√© au-dessus)" value={t.afterTitle} onChange={v=>set("afterTitle",v)}/></Collapsible></>);}

function TabActions({t,set}){return(<><Collapsible title="Actions"><div className="section-desc">Les actions d√©cid√©es en r√©tro (affich√© √† c√¥t√© du ROTI).</div><TF label="Titre actions" value={t.actionTitle} onChange={v=>set("actionTitle",v)}/><TF label="Citation" value={t.actionQuote} onChange={v=>set("actionQuote",v)} multiline/></Collapsible></>);}

function TabResume({t,set}){return(<><Collapsible title="R√©sum√©"><div className="section-desc">La section r√©capitulative avec moyennes, retours √©pingl√©s et actions.</div><TF label="Titre" value={t.summaryTitle} onChange={v=>set("summaryTitle",v)}/><ImageField label="Image de fond" cssUrl value={t.summaryImage} onChange={v=>set("summaryImage",v)}/><GradientBuilder label="Overlay r√©sum√©" description="D√©grad√© sombre par-dessus l'image de fond du r√©sum√©." value={t.summaryOverlay} onChange={v=>set("summaryOverlay",v)}/><TF label="Hint √©pingles" value={t.summaryPinHint} onChange={v=>set("summaryPinHint",v)}/></Collapsible></>);}

function TabOutro({t,set}){const sO=(k,f,v)=>set("outro",{...t.outro,[k]:{...t.outro[k],[f]:v}});const sG=(k,v)=>set("outroGifs",{...t.outroGifs,[k]:v});const keys=[{key:"none",label:"‚è≥ En attente",color:"#6B7280"},{key:"low",label:"üò¨ Basse",color:"#EF4444"},{key:"mid",label:"üëç Moyenne",color:"#F59E0B"},{key:"high",label:"üéâ Haute",color:"#10B981"}];return(<><Collapsible title="Mot de la Fin"><div className="section-desc">Messages de cl√¥ture affich√©s selon la moyenne globale.</div><TF label="Titre" value={t.outroTitle} onChange={v=>set("outroTitle",v)}/></Collapsible>{keys.map(({key,label,color})=>(<Collapsible key={key} title={label} defaultOpen={false}><div className="outro-block"><div className="field-row"><div className="field" style={{maxWidth:60}}><label>Emoji</label><input type="text" value={t.outro[key]?.emoji||""} onChange={e=>sO(key,"emoji",e.target.value)} style={{textAlign:"center",fontSize:18,padding:"4px",width:"100%",borderRadius:6,border:"1px solid #333",background:"#1A1A1A",color:"#E5E5E5",fontFamily:"inherit"}}/></div><TF label="Message" value={t.outro[key]?.text||""} onChange={v=>sO(key,"text",v)} multiline/></div><ImageField label={"GIF ("+key+")"} value={t.outroGifs?.[key]} onChange={v=>sG(key,v)}/></div></Collapsible>))}</>);}

function TabOrdre({t,set}){
  const order = t.sectionOrder || [...DEFAULT_SECTION_ORDER];
  return <SectionReorder order={order} onChange={v => set("sectionOrder", v)}/>;
}

function TabMarkdown({t,set}){return(<><Collapsible title="Labels Markdown / Confluence"><div className="section-desc">Personnalise les titres utilis√©s dans l'export.</div><TF label="Titre" value={t.mdTitle} onChange={v=>set("mdTitle",v)}/><TF label="R√©sum√©" value={t.mdSummary} onChange={v=>set("mdSummary",v)}/><TF label="Moyenne" value={t.mdGlobal} onChange={v=>set("mdGlobal",v)}/><TF label="√âpingl√©s" value={t.mdPinned} onChange={v=>set("mdPinned",v)}/><TF label="Actions" value={t.mdActions} onChange={v=>set("mdActions",v)}/><TF label="D√©tail" value={t.mdDetail} onChange={v=>set("mdDetail",v)}/></Collapsible></>);}

// ============================
// PREVIEW (with ROTI + R√©sum√©)
// ============================
function Preview({t}){
  const bg=s=>s&&s!=="none"?(s.startsWith("url(")?s:`url(${s})`):null;
  return(
  <div>
    <div style={{fontSize:11,fontWeight:700,color:"#555",textTransform:"uppercase",letterSpacing:2,marginBottom:16}}>Aper√ßu Live</div>

    {/* HEADER */}
    <div className="preview-card" style={{position:"relative",minHeight:90,display:"flex",alignItems:"center",padding:"20px 24px",border:"1px solid rgba(255,255,255,0.12)",background:"#1A1A1A"}}>
      {bg(t.headerImage)&&<div style={{position:"absolute",inset:0,backgroundImage:bg(t.headerImage),backgroundSize:"cover",backgroundPosition:"center",opacity:0.45,borderRadius:16}}/>}
      <div style={{position:"absolute",inset:0,background:t.headerGradient,borderRadius:16}}/>
      <div style={{position:"relative",zIndex:1}}><div style={{fontSize:22,fontWeight:800,color:t.accent,letterSpacing:2,textShadow:"0 1px 6px rgba(0,0,0,0.7)"}}>{t.appTitle}</div><div style={{fontSize:11,color:"rgba(255,255,255,0.6)",marginTop:2,textShadow:"0 1px 3px rgba(0,0,0,0.5)"}}>{t.subtitle}</div></div>
    </div>

    {/* REGLES */}
    <div className="preview-card" style={{position:"relative",padding:16}}>
      {bg(t.rulesImage)&&<div style={{position:"absolute",inset:0,backgroundImage:bg(t.rulesImage),backgroundSize:"cover",opacity:0.3,borderRadius:16}}/>}
      <div style={{position:"absolute",inset:0,background:t.rulesOverlayDesktop,borderRadius:16}}/>
      <div style={{position:"relative",zIndex:1}}><div style={{fontSize:14,fontWeight:700,color:t.rulesColor,marginBottom:8}}><span style={{fontSize:20,marginRight:6}}>{t.rulesTitle}</span>{t.rulesName}</div>
        {t.rulesItems.slice(0,3).map((r,i)=>(<div key={i} style={{display:"flex",gap:8,marginBottom:4,fontSize:11,color:t.textPrimary}}><span style={{color:t.rulesDotColor,fontWeight:800}}>‚óè</span>{r}</div>))}
        {t.rulesItems.length>3&&<div style={{fontSize:10,color:t.textMuted}}>+{t.rulesItems.length-3} autres...</div>}
      </div>
    </div>

    {/* Ressenti */}
    <div style={{background:t.cardBg,borderRadius:14,padding:14,marginTop:16,marginBottom:16,border:`1px solid ${t.cardBorder}`}}>
      <div style={{fontSize:13,fontWeight:700,color:t.textPrimary,marginBottom:10}}>{t.vibeTitle}</div>
      <div style={{display:"flex",gap:8}}>{t.vibeChecks.map(vc=>(<div key={vc.id} style={{flex:1,borderRadius:10,border:`2px solid ${vc.border}`,padding:10,textAlign:"center",background:t.dark?"rgba(255,255,255,0.05)":"#FFFAF5"}}>
        <div style={{fontSize:11,fontWeight:700,color:t.dark?vc.border:vc.color,marginBottom:6,display:"flex",alignItems:"center",justifyContent:"center",gap:4}}>
          {vc.image&&<div style={{width:22,height:22,borderRadius:"50%",overflow:"hidden",flexShrink:0}}><img src={vc.image} style={{width:"110%",height:"110%",objectFit:"cover",marginTop:"-5%",marginLeft:"-5%"}}/></div>}{vc.label}</div>
        <div style={{display:"flex",justifyContent:"center",gap:4}}>{[1,2,3,4,5].map(n=>(<div key={n} style={{width:28,height:28,borderRadius:"50%",border:`1px solid ${t.inputBorder}`,background:n===4?vc.bg:t.cardBg,display:"flex",alignItems:"center",justifyContent:"center",fontSize:14,transform:n===4?"scale(1.15)":"scale(1)"}}>{t.ratingLabels[n]?.emoji}</div>))}</div>
      </div>))}</div>
    </div>

    {/* COLONNES FEEDBACKS */}
    <div style={{display:"grid",gridTemplateColumns:`repeat(${t.categories.length},1fr)`,gap:8,marginBottom:16}}>
      {t.categories.map(cat=>{const col=t.columns[cat.id];return(<div key={cat.id} style={{background:t.cardBg,border:`2px solid ${col?.border||"#ccc"}`,borderRadius:12,padding:12,textAlign:"center"}}><div style={{fontSize:12,fontWeight:700,color:col?.color}}>{col?.title}</div><div style={{fontSize:10,color:t.textSecondary,marginTop:4}}>Feedbacks...</div></div>);})}
    </div>

    {/* SAISIE FEEDBACK */}
    <div style={{background:t.cardBg,borderRadius:14,border:`1px solid ${t.cardBorder}`,padding:14,marginBottom:16}}>
      <div style={{fontSize:13,fontWeight:700,color:t.textPrimary,marginBottom:10}}>{t.feedbackTitle}</div>
      <div style={{display:"flex",gap:6,marginBottom:10}}>
        {t.categories.map((cat,i)=>{const col=t.columns[cat.id];const isActive=i===0;return(<div key={cat.id} style={{padding:"4px 10px",borderRadius:12,fontSize:10,fontWeight:isActive?700:500,border:isActive?`2px solid ${cat.btnBorderActive||cat.btnActive||col?.color}`:`1.5px solid ${cat.btnBorderInactive||cat.btnInactive||col?.border}`,background:isActive?(cat.btnActive||col?.color):(cat.btnInactive||cat.bg||col?.border||"transparent"),color:isActive?(cat.btnTextActive||"#fff"):(cat.btnTextInactive||col?.color||"#fff"),opacity:isActive?1:0.7}}>{cat.label}</div>);})}
      </div>
      <div style={{display:"flex",gap:6}}>
        <div style={{flex:1,padding:"8px 12px",borderRadius:10,border:`1px solid ${t.inputBorder}`,background:t.inputBg,fontSize:11,color:t.textMuted}}>Votre retour...</div>
        <div style={{width:34,height:34,borderRadius:10,background:`linear-gradient(135deg, ${t.accent}, ${t.accentDark})`,display:"flex",alignItems:"center",justifyContent:"center",fontSize:16,color:t.dark?"#000":"#fff",fontWeight:700,flexShrink:0}}>+</div>
      </div>
    </div>

    {/* ROTI + ACTIONS */}
    <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:10,marginBottom:16}}>
      {/* ROTI */}
      <div style={{background:t.cardBg,borderRadius:12,border:`2px solid ${t.roti.border}`,padding:12,textAlign:"center"}}>
        <div style={{fontSize:12,fontWeight:700,color:t.dark?t.roti.border:t.roti.color,marginBottom:8,display:"flex",alignItems:"center",justifyContent:"center",gap:6}}>
          {t.roti.image&&<img src={t.roti.image} style={{width:20,height:20,objectFit:"contain"}}/>}
          {t.roti.label}
        </div>
        <div style={{display:"flex",justifyContent:"center",gap:4}}>
          {[1,2,3,4,5].map(n=>(<div key={n} style={{width:26,height:26,borderRadius:"50%",border:`1px solid ${t.inputBorder}`,background:n===4?t.roti.bg:t.cardBg,display:"flex",alignItems:"center",justifyContent:"center",fontSize:13,transform:n===4?"scale(1.12)":"scale(1)"}}>{t.ratingLabels[n]?.emoji}</div>))}
        </div>
        <div style={{fontSize:32,marginTop:8}}>{t.ratingLabels[4]?.emoji}</div>
        <div style={{fontSize:22,fontWeight:900,color:t.dark?t.roti.border:t.roti.color}}>4.0</div>
        <div style={{fontSize:10,color:t.textSecondary}}>/ 5 ‚Äî {t.ratingLabels[4]?.label}</div>
      </div>
      {/* ACTIONS */}
      <div style={{background:t.cardBg,borderRadius:12,border:`2px solid ${t.accent}`,padding:12}}>
        <div style={{fontSize:12,fontWeight:700,color:t.dark?t.accent:t.accentDark,marginBottom:8}}>{t.actionTitle} <span style={{fontSize:10,border:`1px solid ${t.accent}`,borderRadius:10,padding:"1px 8px",color:t.accent,fontWeight:600}}>1/3</span></div>
        <div style={{background:t.accentLight,borderRadius:8,padding:"8px 10px",fontSize:11,color:t.textPrimary,border:`1px solid ${t.accent}40`}}>üéØ Exemple d'action</div>
        <div style={{textAlign:"center",fontSize:10,color:t.accent,fontStyle:"italic",marginTop:10,opacity:0.6}}>{t.actionQuote}</div>
      </div>
    </div>

    {/* R√âSUM√â */}
    <div className="preview-card" style={{position:"relative",padding:16,marginBottom:16}}>
      {bg(t.summaryImage)&&<div style={{position:"absolute",inset:0,backgroundImage:bg(t.summaryImage),backgroundSize:"cover",backgroundPosition:"center top",opacity:0.4,borderRadius:16}}/>}
      <div style={{position:"absolute",inset:0,background:t.summaryOverlay,borderRadius:16}}/>
      <div style={{position:"relative",zIndex:1,textAlign:"center"}}>
        <div style={{fontSize:16,fontWeight:700,color:t.accent,marginBottom:12}}>{t.summaryTitle}</div>
        <div style={{display:"flex",gap:8,justifyContent:"center",marginBottom:12}}>
          {[{label:"Ambiance",emoji:t.ratingLabels[4]?.emoji,val:"4.2",color:t.vibeChecks[0]?.border},{label:"Satisfaction",emoji:t.ratingLabels[3]?.emoji,val:"3.8",color:t.vibeChecks[1]?.border},{label:"ROTI",emoji:t.ratingLabels[4]?.emoji,val:"4.0",color:t.roti.border}].map(v=>(
            <div key={v.label} style={{background:"rgba(255,255,255,0.08)",borderRadius:10,padding:"8px 12px",border:`1px solid ${v.color}44`,minWidth:70}}>
              <div style={{fontSize:18}}>{v.emoji}</div>
              <div style={{fontSize:16,fontWeight:900,color:v.color}}>{v.val}</div>
              <div style={{fontSize:9,color:"rgba(255,255,255,0.5)"}}>{v.label}</div>
            </div>
          ))}
        </div>
        <div style={{fontSize:10,color:"rgba(255,255,255,0.4)",fontStyle:"italic"}}>{t.summaryPinHint}</div>
      </div>
    </div>

    {/* OUTRO */}
    <div className="preview-card" style={{position:"relative",padding:16}}>
      {t.outroGifs?.high&&<div style={{position:"absolute",inset:0,backgroundImage:`url(${t.outroGifs.high})`,backgroundSize:"cover",backgroundPosition:"center",filter:"blur(0.5px)",opacity:0.6,borderRadius:16}}/>}
      <div style={{position:"absolute",inset:0,background:t.summaryOverlay,borderRadius:16}}/>
      <div style={{position:"relative",zIndex:1,textAlign:"center"}}><div style={{fontSize:14,fontWeight:700,color:t.accent,marginBottom:6}}>{t.outroTitle}</div><div style={{fontSize:24,marginBottom:4}}>{t.outro.high?.emoji}</div><div style={{fontSize:12,color:"#fff",fontStyle:"italic"}}>"{t.outro.high?.text}"</div></div>
    </div>

    {/* PALETTE */}
    <div style={{marginTop:16,fontSize:11,fontWeight:700,color:"#555",textTransform:"uppercase",letterSpacing:2,marginBottom:8}}>Palette</div>
    <div style={{display:"flex",gap:4,flexWrap:"wrap"}}>{[t.accent,t.accentDark,t.accentLight,t.bodyBg,t.cardBg,t.textPrimary,t.textSecondary].map((c,i)=>(<div key={i} style={{width:28,height:28,borderRadius:6,background:c,border:"2px solid #333"}} title={c}/>))}</div>
  </div>);
}

// ============================
// MAIN APP
// ============================
// Deep merge: ensures all DEFAULT_TPL fields (including nested) are present when loading themes
const deepMerge=(base,override)=>{const result={...base};for(const k of Object.keys(override)){if(override[k]&&typeof override[k]==="object"&&!Array.isArray(override[k])&&base[k]&&typeof base[k]==="object"&&!Array.isArray(base[k])){result[k]=deepMerge(base[k],override[k]);}else{result[k]=override[k];}}return result;};

function App(){
  const[user,setUser]=useState(null);const[authLoading,setAuthLoading]=useState(true);const[authError,setAuthError]=useState(null);
  useEffect(()=>{if(!auth){setAuthLoading(false);return;}return auth.onAuthStateChanged(u=>{setUser(u);setAuthLoading(false);});},[]);
  const signIn=async()=>{setAuthError(null);try{const p=new firebase.auth.GoogleAuthProvider();p.setCustomParameters({hd:"myunisoft.fr"});await auth.signInWithPopup(p);}catch(e){setAuthError(e.message);}};
  const isAdmin=user&&ADMIN_EMAILS.includes(user.email);

  const[template,setTemplate]=useState(()=>{try{const s=localStorage.getItem("theme-editor-draft");if(s){const parsed=JSON.parse(s);if(!parsed.sectionOrder)parsed.sectionOrder=[...DEFAULT_SECTION_ORDER];return deepMerge(DEFAULT_TPL,parsed);}}catch(e){}return{...DEFAULT_TPL};});
  const[activeTab,setActiveTab]=useState("identite");
  const[saveStatus,setSaveStatus]=useState(null);
  const[customIds,setCustomIds]=useState([]);
  const[customThemes,setCustomThemes]=useState({});

  useEffect(()=>{if(!db)return;const ref=db.ref("customTemplates");ref.on("value",s=>{const v=s.val();setCustomIds(v?Object.keys(v):[]);setCustomThemes(v||{});});return()=>ref.off("value");},[]);
  useEffect(()=>{const t=setTimeout(()=>localStorage.setItem("theme-editor-draft",JSON.stringify(template)),500);return()=>clearTimeout(t);},[template]);

  const set=useCallback((k,v)=>setTemplate(p=>({...p,[k]:v})),[]);

  const loadBase=(id)=>{
    if(id==="__blank"){setTemplate({...DEFAULT_TPL});return;}
    const tpl=window.RETRO_TEMPLATES?.[id];
    if(tpl){const c=JSON.parse(JSON.stringify(tpl));c.id=c.id+"-custom";c.name=c.name+" (Custom)";delete c._custom;if(!c.sectionOrder)c.sectionOrder=[...DEFAULT_SECTION_ORDER];setTemplate(deepMerge(DEFAULT_TPL,c));return;}
    if(db)db.ref("customTemplates/"+id).once("value",s=>{if(s.val()){const v=deepMerge(DEFAULT_TPL,JSON.parse(JSON.stringify(s.val())));if(!v.sectionOrder)v.sectionOrder=[...DEFAULT_SECTION_ORDER];setTemplate(v);}});
  };

  const openCustomTheme=(id)=>{
    const data=customThemes[id];
    if(data){const v=deepMerge(DEFAULT_TPL,JSON.parse(JSON.stringify(data)));if(!v.sectionOrder)v.sectionOrder=[...DEFAULT_SECTION_ORDER];v.id=id;setTemplate(v);setActiveTab("identite");if(baseRef.current)baseRef.current.value="";}
  };

  const[deleteMsg,setDeleteMsg]=useState(null);
  const deleteCustomTheme=async(id,name)=>{if(!db)return;if(!confirm("Supprimer \""+name+"\" de l'app ?"))return;try{await db.ref("customTemplates/"+id).set(null);if(template.id===id){setTemplate(JSON.parse(JSON.stringify(DEFAULT_TPL)));setActiveTab("identite");if(baseRef.current)baseRef.current.value="";}setDeleteMsg("\""+name+"\" supprim√© ‚úì");setTimeout(()=>setDeleteMsg(null),3000);}catch(e){setDeleteMsg("Erreur : "+e.message);setTimeout(()=>setDeleteMsg(null),4000);}};

  const saveToFirebase=async()=>{if(!db||!template.id)return;setSaveStatus("saving");try{const d={...template};delete d._custom;await db.ref("customTemplates/"+template.id).set(d);setSaveStatus("saved");setTimeout(()=>setSaveStatus(null),3000);}catch(e){setSaveStatus("error");alert("Erreur : "+e.message);setTimeout(()=>setSaveStatus(null),3000);}};
  const baseRef=useRef(null);
  const deleteFromFirebase=async()=>{if(!customIds.includes(template.id))return;await deleteCustomTheme(template.id,template.name);};
  const exportJS=()=>{const js="// "+template.name+"\n(function(){if(!window.RETRO_TEMPLATES)window.RETRO_TEMPLATES={};window.RETRO_TEMPLATES["+JSON.stringify(template.id)+"]="+JSON.stringify(template,null,2)+";})();\n";const b=new Blob([js],{type:"text/javascript"});const a=document.createElement("a");a.href=URL.createObjectURL(b);a.download=template.id+".js";a.click();};

  // Tabs dans l'ordre de l'app (comme backstage.js)
  const tabs=[
    {id:"identite",label:"üè∑Ô∏è Identit√©"},
    {id:"couleurs",label:"üé® Couleurs"},
    {id:"header",label:"üîù Entr√©e"},
    {id:"regles",label:"üìã R√®gles"},
    {id:"vibecheck",label:"üé§ Ressenti"},
    {id:"colonnes",label:"üìä Colonnes"},
    {id:"roti",label:"üìà ROTI"},
    {id:"actions",label:"üéØ Actions"},
    {id:"resume",label:"üèÜ R√©sum√©"},
    {id:"outro",label:"üé¨ Outro"},
    {id:"ordre",label:"üîÄ Ordre"},
    {id:"markdown",label:"üìù Export"}
  ];

  if(authLoading)return<div className="login-screen"><div style={{color:"#666"}}>Chargement...</div></div>;
  if(!user)return<div className="login-screen"><div className="login-card">
    <div style={{fontSize:36,marginBottom:12}}>üé≠</div><div style={{fontSize:20,fontWeight:800,color:"#F97316",marginBottom:4}}>√âditeur de Th√®me</div><div style={{fontSize:12,color:"#666",marginBottom:24}}>Connecte-toi pour cr√©er des th√®mes.</div>
    <button onClick={signIn} disabled={authLoading} style={{padding:"12px 32px",borderRadius:10,border:"1px solid #333",background:"#1A1A1A",color:"#E5E5E5",fontSize:14,fontWeight:600,cursor:"pointer",fontFamily:"inherit",display:"flex",alignItems:"center",gap:10,margin:"0 auto"}}>
      <svg width="18" height="18" viewBox="0 0 48 48"><path fill="#EA4335" d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l7.98 6.19C12.43 13.72 17.74 9.5 24 9.5z"/><path fill="#4285F4" d="M46.98 24.55c0-1.57-.15-3.09-.38-4.55H24v9.02h12.94c-.58 2.96-2.26 5.48-4.78 7.18l7.73 6c4.51-4.18 7.09-10.36 7.09-17.65z"/><path fill="#FBBC05" d="M10.53 28.59c-.48-1.45-.76-2.99-.76-4.59s.27-3.14.76-4.59l-7.98-6.19C.92 16.46 0 20.12 0 24c0 3.88.92 7.54 2.56 10.78l7.97-6.19z"/><path fill="#34A853" d="M24 48c6.48 0 11.93-2.13 15.89-5.81l-7.73-6c-2.15 1.45-4.92 2.3-8.16 2.3-6.26 0-11.57-4.22-13.47-9.91l-7.98 6.19C6.51 42.62 14.62 48 24 48z"/></svg>
      {authLoading?"Connexion‚Ä¶":"Se connecter"}</button>
    <div style={{fontSize:10,color:"#999",marginTop:16}}>R√©serv√© aux admins MyUnisoft GI</div>
    {authError&&<div style={{marginTop:12,fontSize:12,color:"#EF4444",background:"#7F1D1D22",borderRadius:8,padding:"8px 12px"}}>{authError}</div>}
  </div></div>;
  if(!isAdmin)return<div className="login-screen"><div className="login-card"><div style={{fontSize:36,marginBottom:12}}>üîí</div><div style={{fontSize:16,fontWeight:700,color:"#EF4444",marginBottom:8}}>Acc√®s r√©serv√© aux admins</div><div style={{fontSize:12,color:"#666"}}>{user.email}</div><button onClick={()=>auth.signOut()} style={{marginTop:20,padding:"8px 20px",borderRadius:8,border:"1px solid #333",background:"none",color:"#aaa",cursor:"pointer",fontFamily:"inherit"}}>Se d√©connecter</button></div></div>;

  const isExisting=customIds.includes(template.id);

  return(<div className="app"><div className="sidebar">
    <div className="sidebar-header"><div style={{display:"flex",justifyContent:"space-between",alignItems:"center"}}><h1>üé≠ √âditeur de Th√®me</h1><button onClick={()=>auth.signOut()} style={{background:"none",border:"none",cursor:"pointer",fontSize:11,color:"#555"}} title="Se d√©connecter">üëã {user.displayName?.split(" ")[0]}</button></div><p>Cr√©e ton template, enregistre-le dans l'app.</p></div>
    <div className="base-picker"><label style={{fontSize:11,fontWeight:600,color:"#888",display:"block",marginBottom:4}}>Partir d'un th√®me existant :</label>
      <select ref={baseRef} onChange={e=>loadBase(e.target.value)} defaultValue=""><option value="" disabled>‚Äî Choisir une base ‚Äî</option><option value="__blank">üÜï Template vierge</option>
        <optgroup label="Th√®mes officiels">{Object.values(window.RETRO_TEMPLATES||{}).filter(t=>!t._custom).map(t=><option key={t.id} value={t.id}>{t.preview} {t.name}</option>)}</optgroup>
        {customIds.length>0&&<optgroup label="Th√®mes custom">{customIds.map(id=><option key={id} value={id}>‚ú® {id}</option>)}</optgroup>}
      </select></div>
    {customIds.length>0&&<div className="custom-themes">
      <div className="custom-themes-title">Mes th√®mes enregistr√©s <span>{customIds.length}</span></div>
      {deleteMsg&&<div style={{fontSize:11,fontWeight:600,color:deleteMsg.includes("Erreur")?"#EF4444":"#10B981",background:deleteMsg.includes("Erreur")?"#1F0A0A":"#0A1F15",border:"1px solid "+(deleteMsg.includes("Erreur")?"#7F1D1D":"#065F46"),borderRadius:8,padding:"6px 10px",marginBottom:8,textAlign:"center"}}>{deleteMsg}</div>}
      {customIds.map(id=>{const ct=customThemes[id];const name=ct?.name||id;const preview=ct?.preview||"‚ú®";const isActive=template.id===id;return(
        <div key={id} className={`ct-item${isActive?" active":""}`} onClick={()=>openCustomTheme(id)} title={"Ouvrir "+name}>
          <div className="ct-emoji">{preview}</div>
          <div className="ct-info"><div className="ct-name">{name}</div><div className="ct-id">{id}</div></div>
          <div className="ct-actions">
            <button className="ct-btn delete" onClick={e=>{e.stopPropagation();deleteCustomTheme(id,name);}} title="Supprimer">üóëÔ∏è</button>
          </div>
        </div>
      );})}
    </div>}
    <div className="tabs">{tabs.map(tab=><button key={tab.id} className={`tab ${activeTab===tab.id?"active":""}`} onClick={()=>setActiveTab(tab.id)}>{tab.label}</button>)}</div>
    
    <div className="section">
      {activeTab==="identite"&&<TabIdentite t={template} set={set}/>}
      {activeTab==="couleurs"&&<TabCouleurs t={template} set={set}/>}
      {activeTab==="header"&&<TabHeader t={template} set={set}/>}
      {activeTab==="regles"&&<TabRegles t={template} set={set}/>}
      {activeTab==="vibecheck"&&<TabVibeCheck t={template} set={set}/>}
      {activeTab==="colonnes"&&<TabColonnes t={template} set={set}/>}
      {activeTab==="roti"&&<TabRoti t={template} set={set}/>}
      {activeTab==="actions"&&<TabActions t={template} set={set}/>}
      {activeTab==="resume"&&<TabResume t={template} set={set}/>}
      {activeTab==="outro"&&<TabOutro t={template} set={set}/>}
      {activeTab==="ordre"&&<TabOrdre t={template} set={set}/>}
      {activeTab==="markdown"&&<TabMarkdown t={template} set={set}/>}
    </div>
    
    <div className="status-bar"><span><span className="status-dot" style={{background:saveStatus==="saved"?"#10B981":saveStatus==="saving"?"#F59E0B":saveStatus==="error"?"#EF4444":"#555"}}/>{saveStatus==="saving"?"Enregistrement...":saveStatus==="saved"?"Enregistr√© ‚úì":saveStatus==="error"?"Erreur":isExisting?"Th√®me existant":"Non enregistr√©"}</span><span style={{color:"#444"}}>ID: {template.id}</span></div>
    <div className="btn-bar"><button className="btn-secondary" onClick={exportJS} title="T√©l√©charger .js">‚¨áÔ∏è .js</button>{isExisting&&<button className="btn-danger" onClick={deleteFromFirebase}>üóëÔ∏è</button>}<button className="btn-primary" onClick={saveToFirebase} disabled={saveStatus==="saving"} style={{opacity:saveStatus==="saving"?0.6:1}}>{saveStatus==="saving"?"‚è≥...":isExisting?"üíæ Mettre √† jour":"üöÄ Enregistrer dans l'app"}</button></div>
  </div><div className="preview-panel"><Preview t={template}/></div></div>);
}
ReactDOM.createRoot(document.getElementById("root")).render(<App/>);
</script>
</body>
</html>
